<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="图书借阅系统">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#007AFF">
  
  <title>图书借阅系统</title>
  
  <!-- iOS优化的图标和启动画面 -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assert/app-icon-180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assert/app-icon-152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assert/app-icon-120.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assert/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assert/favicon-16x16.png">
  
  <!-- PWA支持 -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- 指定技术栈CDN资源 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/less@4.2.0/dist/less.min.js"></script>
  
  <!-- 公共样式和脚本 -->
  <link rel="stylesheet/less" type="text/css" href="./h5-common.less" />
  <script src="./h5-common.js"></script>
  
  <style>
    /* 专门为首页框架的样式增强 */
    :root {
      --nav-height: 83px;
      --iframe-border-radius: 20px;
      --transition-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    /* 主容器特殊布局 */
    .main-frame-container {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      background: var(--background-grouped, #F2F2F7);
      position: relative;
      overflow: hidden;
    }
    
    /* 内容区域优化 */
    .frame-content-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      padding: 8px 8px 0 8px;
      padding-top: max(8px, env(safe-area-inset-top));
    }
    
    /* iframe容器增强 */
    .iframe-container {
      width: 100%;
      height: 100%;
      border-radius: var(--iframe-border-radius);
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      background: #FFFFFF;
      position: relative;
      transition: all 0.3s var(--transition-spring);
    }
    
    .iframe-container.loading {
      transform: scale(0.98);
      opacity: 0.8;
    }
    
    /* iframe样式 */
    .frame-content-iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: var(--iframe-border-radius);
      background: #FFFFFF;
      display: block;
    }
    
    /* 全局加载遮罩增强 */
    .global-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(242, 242, 247, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      border-radius: var(--iframe-border-radius);
    }
    
    .loading-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 20px;
      padding: 32px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border: 0.5px solid rgba(255, 255, 255, 0.8);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 122, 255, 0.2);
      border-top: 3px solid #007AFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 17px;
      color: #3C3C43;
      font-weight: 500;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
    }
    
    /* 底部导航栏增强 */
    .enhanced-bottom-nav {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-top: 0.5px solid rgba(60, 60, 67, 0.2);
      padding: 8px 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      position: relative;
      z-index: 1000;
      height: var(--nav-height);
      display: flex;
      align-items: center;
    }
    
    .nav-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      padding: 0 16px;
    }
    
    .enhanced-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      border-radius: 12px;
      text-decoration: none;
      color: #8E8E93;
      transition: all 0.2s ease-out;
      position: relative;
      min-width: 60px;
      min-height: 50px;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .enhanced-nav-item:hover {
      color: #007AFF;
      background: rgba(0, 122, 255, 0.08);
      text-decoration: none;
    }
    
    .enhanced-nav-item.active {
      color: #007AFF;
      background: rgba(0, 122, 255, 0.12);
    }
    
    .enhanced-nav-item.active .nav-icon {
      transform: scale(1.15);
    }
    
    .nav-icon {
      font-size: 24px;
      margin-bottom: 4px;
      transition: transform 0.3s var(--transition-spring);
      line-height: 1;
    }
    
    .nav-text {
      font-size: 12px;
      font-weight: 500;
      line-height: 1;
      letter-spacing: -0.1px;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
    }
    
    .nav-badge {
      position: absolute;
      top: 2px;
      right: 8px;
      background: #FF3B30;
      color: #FFFFFF;
      border-radius: 10px;
      min-width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
    }
    
    /* 页面切换动画 */
    .iframe-container.switching {
      animation: switchPage 0.4s var(--transition-spring);
    }
    
    @keyframes switchPage {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(0.95);
        opacity: 0.7;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    /* 导航项点击动画 */
    .enhanced-nav-item:active {
      transform: scale(0.95);
    }
    
    /* 错误状态 */
    .iframe-error {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px 20px;
      text-align: center;
      background: #FFFFFF;
      border-radius: var(--iframe-border-radius);
    }
    
    .error-icon {
      font-size: 48px;
      color: #8E8E93;
      margin-bottom: 16px;
    }
    
    .error-title {
      font-size: 20px;
      font-weight: 600;
      color: #1C1C1E;
      margin-bottom: 8px;
    }
    
    .error-message {
      font-size: 16px;
      color: #8E8E93;
      margin-bottom: 24px;
      line-height: 1.4;
    }
    
    .retry-button {
      background: #007AFF;
      color: #FFFFFF;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease-out;
    }
    
    .retry-button:hover {
      background: #0056CC;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    
    /* 响应式适配 */
    @media (max-width: 375px) {
      .frame-content-area {
        padding: 4px 4px 0 4px;
      }
      
      .iframe-container {
        border-radius: 16px;
      }
      
      .nav-icon {
        font-size: 22px;
      }
      
      .nav-text {
        font-size: 11px;
      }
    }
    
    /* 横屏适配 */
    @media (orientation: landscape) and (max-height: 500px) {
      :root {
        --nav-height: 65px;
        --iframe-border-radius: 12px;
      }
      
      .enhanced-nav-item {
        min-height: 40px;
      }
      
      .nav-icon {
        font-size: 20px;
      }
      
      .nav-text {
        font-size: 10px;
      }
    }
    
    /* 深色模式支持 */
    @media (prefers-color-scheme: dark) {
      .main-frame-container {
        background: #000000;
      }
      
      .iframe-container {
        background: #1C1C1E;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      
      .frame-content-iframe {
        background: #1C1C1E;
      }
      
      .enhanced-bottom-nav {
        background: rgba(28, 28, 30, 0.8);
        border-top-color: rgba(84, 84, 88, 0.4);
      }
      
      .global-loading-overlay {
        background: rgba(0, 0, 0, 0.8);
      }
      
      .loading-content {
        background: rgba(28, 28, 30, 0.95);
        border-color: rgba(84, 84, 88, 0.4);
      }
      
      .loading-text {
        color: #EBEBF5;
      }
      
      .iframe-error {
        background: #1C1C1E;
      }
      
      .error-title {
        color: #FFFFFF;
      }
    }
  </style>
</head>
<body x-data="appFramework()" x-init="init()">
  <div class="main-frame-container">
    <!-- 主内容区域 -->
    <div class="frame-content-area">
      <div class="iframe-container" :class="{ 'loading': pageLoading, 'switching': pageSwitching }">
        <!-- 全局加载遮罩 -->
        <div class="global-loading-overlay" x-show="globalLoading" x-transition>
          <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text" x-text="loadingMessage"></p>
          </div>
        </div>
        
        <!-- iframe 内容 -->
        <iframe 
          class="frame-content-iframe" 
          :src="currentPageUrl" 
          @load="onIframeLoad()"
          @error="onIframeError()"
          x-show="!showError"
          frameborder="0"
          scrolling="auto"
          allowtransparency="true"
        ></iframe>
        
        <!-- 错误状态 -->
        <div class="iframe-error" x-show="showError">
          <i class="bi bi-exclamation-triangle error-icon"></i>
          <h3 class="error-title">页面加载失败</h3>
          <p class="error-message">网络连接异常，请检查网络设置后重试</p>
          <button class="retry-button" @click="retryLoad()">
            <i class="bi bi-arrow-clockwise"></i> 重新加载
          </button>
        </div>
      </div>
    </div>
    
    <!-- 增强的底部导航栏 -->
    <nav class="enhanced-bottom-nav">
      <div class="nav-container">
        <!-- 图书模块 -->
        <a href="#" 
           class="enhanced-nav-item" 
           :class="{ 'active': currentTab === 'books' }"
           @click.prevent="switchTab('books')"
           @touchstart="onNavTouchStart($event)"
           @touchend="onNavTouchEnd($event)">
          <i class="bi bi-book nav-icon"></i>
          <span class="nav-text">图书</span>
        </a>
        
        <!-- 借阅模块 -->
        <a href="#" 
           class="enhanced-nav-item" 
           :class="{ 'active': currentTab === 'borrows' }"
           @click.prevent="switchTab('borrows')"
           @touchstart="onNavTouchStart($event)"
           @touchend="onNavTouchEnd($event)">
          <i class="bi bi-journal-check nav-icon"></i>
          <span class="nav-text">借阅</span>
          <template x-if="borrowCount > 0">
            <span class="nav-badge" x-text="borrowCount > 99 ? '99+' : borrowCount"></span>
          </template>
        </a>
        
        <!-- 设置模块 -->
        <a href="#" 
           class="enhanced-nav-item" 
           :class="{ 'active': currentTab === 'settings' }"
           @click.prevent="switchTab('settings')"
           @touchstart="onNavTouchStart($event)"
           @touchend="onNavTouchEnd($event)">
          <i class="bi bi-gear nav-icon"></i>
          <span class="nav-text">设置</span>
          <template x-if="hasNotifications">
            <span class="nav-badge">•</span>
          </template>
        </a>
      </div>
    </nav>
  </div>

  <script>
    function appFramework() {
      return {
        // 状态管理
        currentTab: 'books',
        previousTab: null,
        globalLoading: false,
        pageLoading: false,
        pageSwitching: false,
        showError: false,
        loadingMessage: '正在加载...',
        
        // 数据状态
        borrowCount: 0,
        hasNotifications: false,
        user: null,
        
        // 页面配置
        pages: {
          books: './h5-book.html',
          borrows: './h5-borrow.html',
          settings: './h5-setting.html'
        },
        
        // 计算属性
        get currentPageUrl() {
          return this.pages[this.currentTab] || this.pages.books;
        },
        
        // 初始化
        async init() {
          console.log('[H5框架] 启动应用框架');
          
          // 设置初始状态
          this.globalLoading = true;
          this.loadingMessage = '正在验证登录状态...';
          
          try {
            // 检查用户登录状态
            await this.checkAuthentication();
            
            // 加载用户数据
            await this.loadUserData();
            
            // 开始定期更新数据
            this.startPeriodicUpdates();
            
            // 设置页面可见性监听
            this.setupVisibilityListener();
            
            console.log('[H5框架] 应用框架启动完成');
            
          } catch (error) {
            console.error('[H5框架] 启动失败:', error);
            this.handleAuthError();
          } finally {
            this.globalLoading = false;
          }
        },
        
        // 认证检查
        async checkAuthentication() {
          try {
            const response = await H5API.auth.getCurrentUser();
            
            if (!response.success || !response.user) {
              throw new Error('用户信息无效');
            }
            
            this.user = response.user;
            console.log('[H5框架] 用户已登录:', this.user.username);
            
          } catch (error) {
            console.log('[H5框架] 用户未登录，跳转到登录页面');
            throw error;
          }
        },
        
        // 处理认证错误
        handleAuthError() {
          H5Utils.hapticFeedback('error');
          H5Toast.error('登录状态已过期，即将跳转到登录页面');
          
          setTimeout(() => {
            window.location.href = './h5-login.html';
          }, 2000);
        },
        
        // 加载用户数据
        async loadUserData() {
          this.loadingMessage = '正在加载数据...';
          
          try {
            // 并行加载多个数据
            const [borrowCountResult, notificationsResult] = await Promise.all([
              this.loadBorrowCount(),
              this.loadNotifications()
            ]);
            
            console.log('[H5框架] 用户数据加载完成');
            
          } catch (error) {
            console.error('[H5框架] 用户数据加载失败:', error);
            // 数据加载失败不阻止应用启动
          }
        },
        
        // 加载借阅数量
        async loadBorrowCount() {
          try {
            const response = await H5API.borrows.getCount();
            if (response.success) {
              this.borrowCount = response.count || 0;
            }
          } catch (error) {
            console.error('[H5框架] 借阅数量加载失败:', error);
          }
        },
        
        // 加载通知
        async loadNotifications() {
          try {
            const response = await H5API.system.getNotifications();
            if (response.success) {
              this.hasNotifications = response.notifications?.some(n => !n.read) || false;
            }
          } catch (error) {
            console.error('[H5框架] 通知加载失败:', error);
          }
        },
        
        // 标签页切换
        async switchTab(newTab) {
          if (this.currentTab === newTab || this.pageSwitching) {
            return;
          }
          
          console.log(`[H5框架] 切换标签页: ${this.currentTab} -> ${newTab}`);
          
          // 触觉反馈
          H5Utils.hapticFeedback('light');
          
          // 保存前一个标签页
          this.previousTab = this.currentTab;
          this.currentTab = newTab;
          
          // 开始切换动画
          this.pageSwitching = true;
          this.pageLoading = true;
          
          // 特定页面的预处理
          await this.handleTabSwitch(newTab);
          
          // 延迟重置动画状态
          setTimeout(() => {
            this.pageSwitching = false;
          }, 400);
        },
        
        // 处理特定标签页切换
        async handleTabSwitch(tab) {
          switch (tab) {
            case 'borrows':
              // 刷新借阅数据
              await this.loadBorrowCount();
              break;
            case 'settings':
              // 刷新通知状态
              await this.loadNotifications();
              break;
          }
        },
        
        // iframe加载完成
        onIframeLoad() {
          console.log(`[H5框架] 页面加载完成: ${this.currentPageUrl}`);
          this.pageLoading = false;
          this.showError = false;
          
          // 触觉反馈
          H5Utils.hapticFeedback('success');
        },
        
        // iframe加载错误
        onIframeError() {
          console.error(`[H5框架] 页面加载失败: ${this.currentPageUrl}`);
          this.pageLoading = false;
          this.showError = true;
          
          // 触觉反馈
          H5Utils.hapticFeedback('error');
          H5Toast.error('页面加载失败，请检查网络连接');
        },
        
        // 重试加载
        retryLoad() {
          console.log('[H5框架] 重试加载页面');
          this.showError = false;
          this.pageLoading = true;
          
          // 触觉反馈
          H5Utils.hapticFeedback('light');
          
          // 强制刷新iframe
          const iframe = document.querySelector('.frame-content-iframe');
          if (iframe) {
            iframe.src = this.currentPageUrl + '?_t=' + Date.now();
          }
        },
        
        // 导航触摸事件
        onNavTouchStart(event) {
          // 添加触摸反馈
          event.currentTarget.style.transform = 'scale(0.95)';
        },
        
        onNavTouchEnd(event) {
          // 恢复原始状态
          setTimeout(() => {
            event.currentTarget.style.transform = '';
          }, 150);
        },
        
        // 开始定期更新
        startPeriodicUpdates() {
          // 每30秒更新借阅数量
          setInterval(async () => {
            try {
              await this.loadBorrowCount();
            } catch (error) {
              // 静默失败
            }
          }, 30000);
          
          // 每60秒检查通知
          setInterval(async () => {
            try {
              await this.loadNotifications();
            } catch (error) {
              // 静默失败
            }
          }, 60000);
        },
        
        // 页面可见性监听
        setupVisibilityListener() {
          document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
              // 页面重新可见时刷新数据
              console.log('[H5框架] 页面重新可见，刷新数据');
              this.loadUserData();
            }
          });
        },
        
        // 应用生命周期方法
        onBeforeUnload() {
          console.log('[H5框架] 应用即将卸载');
        },
        
        // 错误处理
        handleError(error, context = '') {
          console.error(`[H5框架] ${context}发生错误:`, error);
          H5Toast.error(`${context}失败，请稍后重试`);
          H5Utils.hapticFeedback('error');
        }
      }
    }
    
    // 页面卸载前的清理
    window.addEventListener('beforeunload', () => {
      console.log('[H5框架] 清理资源');
    });
    
    // 全局错误捕获
    window.addEventListener('error', (e) => {
      console.error('[H5框架] 全局错误:', e.error);
    });
    
    // 处理返回按钮（防止误操作）
    window.addEventListener('popstate', (e) => {
      // 在移动端可以添加确认对话框
      console.log('[H5框架] 用户尝试返回');
    });
  </script>
</body>
</html>
