<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>设置</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/less@4.2.0/dist/less.min.js"></script>
  <link rel="stylesheet/less" type="text/css" href="/h5/common.less" />
  <style>
    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #f1f3f4;
    }
    
    .setting-item:last-child {
      border-bottom: none;
    }
    
    .setting-label {
      display: flex;
      align-items: center;
      font-weight: 500;
      color: #212529;
    }
    
    .setting-value {
      color: #6c757d;
      font-size: 0.875rem;
    }
    
    .setting-icon {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.75rem;
      font-size: 1rem;
    }
    
    .icon-primary {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .icon-success {
      background: #e8f5e8;
      color: #2e7d32;
    }
    
    .icon-warning {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .icon-danger {
      background: #ffebee;
      color: #d32f2f;
    }
    
    .btn-logout {
      background: #dc3545;
      border: none;
      color: white;
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-weight: 500;
    }
    
    .btn-logout:hover {
      background: #c82333;
      color: white;
    }
    
    .error-message { 
      background: #fee2e2; 
      border: 1px solid #fecaca; 
      color: #991b1b; 
      padding: 1rem; 
      border-radius: 0.5rem; 
      margin: 1rem 0; 
    }
    
    .success-message { 
      background: #d1fae5; 
      border: 1px solid #a7f3d0; 
      color: #065f46; 
      padding: 1rem; 
      border-radius: 0.5rem; 
      margin: 1rem 0; 
    }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1050;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin: 1rem;
      max-width: 400px;
      width: 100%;
    }
  </style>
</head>
<body x-data="settingPage()" x-init="init()">
  <div class="container py-3">
    <!-- 页面标题 -->
    <div class="mb-3">
      <h5 class="mb-0">设置</h5>
    </div>

    <!-- 错误信息显示 -->
    <template x-if="errorMessage">
      <div class="error-message">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span x-text="errorMessage"></span>
      </div>
    </template>

    <!-- 成功信息显示 -->
    <template x-if="successMessage">
      <div class="success-message">
        <i class="bi bi-check-circle me-2"></i>
        <span x-text="successMessage"></span>
      </div>
    </template>

    <!-- 用户信息卡片 -->
    <div class="card-h5">
      <div class="setting-item">
        <div class="setting-label">
          <div class="setting-icon icon-primary">
            <i class="bi bi-person"></i>
          </div>
          <span>用户名</span>
        </div>
        <div class="setting-value" x-text="user?.username || '--'"></div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <div class="setting-icon icon-success">
            <i class="bi bi-envelope"></i>
          </div>
          <span>邮箱</span>
        </div>
        <div class="setting-value" x-text="user?.email || '--'"></div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <div class="setting-icon icon-warning">
            <i class="bi bi-calendar"></i>
          </div>
          <span>注册时间</span>
        </div>
        <div class="setting-value" x-text="formatDate(user?.createdAt)"></div>
      </div>
    </div>

    <!-- 功能设置卡片 -->
    <div class="card-h5">
      <div class="setting-item" @click="showChangePasswordModal = true" style="cursor: pointer;">
        <div class="setting-label">
          <div class="setting-icon icon-primary">
            <i class="bi bi-key"></i>
          </div>
          <span>修改密码</span>
        </div>
        <div class="setting-value">
          <i class="bi bi-chevron-right"></i>
        </div>
      </div>
    </div>

    <!-- 退出登录按钮 -->
    <div class="card-h5">
      <button class="btn btn-logout" @click="logout()">
        <i class="bi bi-box-arrow-right me-2"></i>
        退出登录
      </button>
    </div>
  </div>

  <!-- 修改密码模态框 -->
  <template x-if="showChangePasswordModal">
    <div class="modal-backdrop" @click="showChangePasswordModal = false">
      <div class="modal-content" @click.stop>
        <h6 class="mb-3">修改密码</h6>
        
        <div class="mb-3">
          <label class="form-label">当前密码</label>
          <input 
            type="password" 
            class="form-control" 
            x-model="passwordForm.currentPassword"
            placeholder="请输入当前密码"
          >
        </div>
        
        <div class="mb-3">
          <label class="form-label">新密码</label>
          <input 
            type="password" 
            class="form-control" 
            x-model="passwordForm.newPassword"
            placeholder="请输入新密码"
          >
        </div>
        
        <div class="mb-3">
          <label class="form-label">确认新密码</label>
          <input 
            type="password" 
            class="form-control" 
            x-model="passwordForm.confirmPassword"
            placeholder="请再次输入新密码"
          >
        </div>
        
        <div class="d-flex gap-2">
          <button 
            class="btn btn-secondary flex-fill" 
            @click="showChangePasswordModal = false"
            :disabled="changingPassword"
          >
            取消
          </button>
          <button 
            class="btn btn-primary flex-fill" 
            @click="changePassword()"
            :disabled="changingPassword"
          >
            <span x-text="changingPassword ? '修改中...' : '确认修改'"></span>
          </button>
        </div>
      </div>
    </div>
  </template>

  <script>
    function settingPage() {
      return {
        // 响应式数据
        user: null,
        errorMessage: '',
        successMessage: '',
        showChangePasswordModal: false,
        changingPassword: false,
        passwordForm: {
          currentPassword: '',
          newPassword: '',
          confirmPassword: ''
        },
        
        // 初始化方法
        async init() {
          console.log('[设置页面] 初始化');
          
          try {
            await this.getCurrentUser();
          } catch (error) {
            console.error('[设置页面] 初始化失败:', error);
            this.errorMessage = '页面初始化失败，请刷新重试';
          }
        },
        
        // 获取当前用户信息
        async getCurrentUser() {
          console.log('[设置页面] 开始获取当前用户信息');
          
          try {
            const response = await fetch('/api/current-user', { 
              credentials: 'include',
              headers: {
                'Accept': 'application/json'
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('[设置页面] 用户信息响应:', data);
            
            if (!data.success) {
              throw new Error(data.message || '获取用户信息失败');
            }
            
            if (!data.user) {
              throw new Error('用户信息为空');
            }
            
            this.user = data.user;
            console.log('[设置页面] 成功获取用户信息:', this.user);
            
          } catch (error) {
            console.error('[设置页面] 获取用户信息失败:', error);
            
            if (error.message.includes('401') || error.message.includes('未登录')) {
              // 跳转到登录页面
              window.location.href = '/h5/h5-login.html';
              return;
            }
            
            throw error;
          }
        },
        
        // 格式化日期
        formatDate(dateStr) {
          if (!dateStr) return '--';
          try {
            return new Date(dateStr).toISOString().split('T')[0];
          } catch (e) { 
            console.warn('[设置页面] 日期格式化失败:', dateStr, e);
            return dateStr; 
          }
        },
        
        // 修改密码
        async changePassword() {
          if (this.changingPassword) return;
          
          // 验证表单
          if (!this.passwordForm.currentPassword.trim()) {
            this.errorMessage = '请输入当前密码';
            return;
          }
          
          if (!this.passwordForm.newPassword.trim()) {
            this.errorMessage = '请输入新密码';
            return;
          }
          
          if (this.passwordForm.newPassword.length < 6) {
            this.errorMessage = '新密码长度不能少于6位';
            return;
          }
          
          if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
            this.errorMessage = '两次输入的新密码不一致';
            return;
          }
          
          console.log('[设置页面] 开始修改密码');
          this.changingPassword = true;
          this.errorMessage = '';
          this.successMessage = '';
          
          try {
            const payload = {
              currentPassword: this.passwordForm.currentPassword,
              newPassword: this.passwordForm.newPassword
            };
            
            const response = await fetch('/api/change-password', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('[设置页面] 修改密码响应:', data);
            
            if (data.success) {
              this.successMessage = '密码修改成功';
              this.showChangePasswordModal = false;
              this.passwordForm = {
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
              };
            } else {
              throw new Error(data.message || '修改密码失败');
            }
          } catch (error) {
            console.error('[设置页面] 修改密码失败:', error);
            this.errorMessage = `修改密码失败: ${error.message}`;
          } finally {
            this.changingPassword = false;
          }
        },
        
        // 退出登录
        async logout() {
          console.log('[设置页面] 用户退出登录');
          
          if (!confirm('确定要退出登录吗？')) {
            return;
          }
          
          try {
            await fetch('/api/logout', { 
              method: 'POST', 
              credentials: 'include' 
            });
          } catch (error) {
            console.error('[设置页面] 退出登录请求失败:', error);
          } finally {
            window.location.href = '/h5/h5-login.html';
          }
        }
      }
    }
  </script>
</body>
</htm