<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="图书借阅系统">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#007AFF">
  
  <title>登录 - 图书借阅系统</title>
  
  <!-- iOS优化的图标 -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assert/app-icon-180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assert/app-icon-152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assert/app-icon-120.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assert/favicon-32x32.png">
  
  <!-- PWA支持 -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- 指定技术栈CDN资源 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/less@4.2.0/dist/less.min.js"></script>
  
  <!-- 公共样式和脚本 -->
  <link rel="stylesheet/less" type="text/css" href="./h5-common.less" />
  <script src="./h5-common.js"></script>
  
  <style>
    /* 专门为登录页面的样式增强 */
    :root {
      --login-primary: #007AFF;
      --login-primary-hover: #0056CC;
      --login-primary-light: #B3D9FF;
      --login-card-bg: rgba(255, 255, 255, 0.95);
      --login-input-bg: rgba(255, 255, 255, 0.8);
      --login-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      --login-border: rgba(60, 60, 67, 0.2);
      --gradient-start: #667eea;
      --gradient-end: #764ba2;
    }
    
    /* 主容器布局 */
    .login-main-container {
      min-height: 100vh;
      min-height: 100dvh;
      background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 20px) env(safe-area-inset-bottom, 20px) env(safe-area-inset-left, 20px);
      position: relative;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    }
    
    /* 背景装饰元素 */
    .login-main-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
      animation: backgroundFloat 20s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes backgroundFloat {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50% { transform: translate(-10px, -10px) rotate(5deg); }
    }
    
    /* 登录容器 */
    .login-container {
      width: 100%;
      max-width: 380px;
      padding: 0 20px;
      position: relative;
      z-index: 1;
      animation: slideInUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @keyframes slideInUp {
      0% {
        opacity: 0;
        transform: translateY(60px) scale(0.95);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* 登录卡片 */
    .login-card {
      background: var(--login-card-bg);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 28px;
      padding: 48px 32px;
      box-shadow: var(--login-shadow), 
                  0 8px 16px rgba(0, 0, 0, 0.05),
                  inset 0 1px 0 rgba(255, 255, 255, 0.9);
      border: 1px solid var(--login-border);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease-out;
    }
    
    .login-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15), 
                  0 12px 24px rgba(0, 0, 0, 0.08),
                  inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }
    
    /* 顶部装饰条 */
    .login-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
      border-radius: 28px 28px 0 0;
    }
    
    /* Logo和标题区域 */
    .logo-section {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeInDown 1s ease-out 0.3s both;
    }
    
    @keyframes fadeInDown {
      0% {
        opacity: 0;
        transform: translateY(-20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .app-logo {
      width: 88px;
      height: 88px;
      border-radius: 22px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      background: linear-gradient(135deg, var(--login-primary), var(--login-primary-hover));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
    }
    
    .app-logo:hover {
      transform: scale(1.05) rotate(5deg);
    }
    
    .app-title {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
      margin: 0;
      letter-spacing: -0.8px;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .app-subtitle {
      font-size: 17px;
      color: #666;
      margin-top: 8px;
      font-weight: 400;
      letter-spacing: -0.2px;
    }
    
    /* 表单区域 */
    .login-form {
      animation: fadeInUp 1s ease-out 0.5s both;
    }
    
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .form-group-enhanced {
      margin-bottom: 28px;
      position: relative;
    }
    
    .form-label-enhanced {
      display: block;
      font-size: 17px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 12px;
      letter-spacing: -0.3px;
      transition: color 0.3s ease;
    }
    
    .input-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .form-control-enhanced {
      width: 100%;
      padding: 18px 24px;
      padding-left: 56px;
      font-size: 17px;
      border: 2px solid var(--login-border);
      border-radius: 16px;
      background: var(--login-input-bg);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      font-family: inherit;
      color: #1a1a1a;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .form-control-enhanced:focus {
      border-color: var(--login-primary);
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 0 6px var(--login-primary-light);
      transform: translateY(-2px);
    }
    
    .form-control-enhanced:focus + .input-icon {
      color: var(--login-primary);
      transform: scale(1.1);
    }
    
    .form-control-enhanced::placeholder {
      color: #999;
      font-weight: 400;
    }
    
    .input-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: #8e8e93;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
      z-index: 1;
    }
    
    /* 登录按钮 */
    .login-button {
      width: 100%;
      padding: 20px 24px;
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      background: linear-gradient(135deg, var(--login-primary) 0%, var(--login-primary-hover) 100%);
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
      margin-top: 12px;
      box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .login-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .login-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(0, 122, 255, 0.4);
    }
    
    .login-button:hover::before {
      left: 100%;
    }
    
    .login-button:active {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0, 122, 255, 0.3);
    }
    
    .login-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
    }
    
    .login-button:disabled:hover {
      transform: none;
    }
    
    /* 加载状态 */
    .loading-spinner-inline {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 12px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* 错误消息 */
    .error-message-enhanced {
      background: rgba(255, 59, 48, 0.1);
      color: #FF3B30;
      padding: 16px 20px;
      border-radius: 14px;
      font-size: 15px;
      margin-top: 20px;
      border: 1px solid rgba(255, 59, 48, 0.2);
      display: none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      animation: errorSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .error-message-enhanced.show {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    @keyframes errorSlideIn {
      0% {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .error-icon {
      font-size: 18px;
      color: #FF3B30;
    }
    
    /* 成功状态 */
    .success-message-enhanced {
      background: rgba(52, 199, 89, 0.1);
      color: #34C759;
      padding: 16px 20px;
      border-radius: 14px;
      font-size: 15px;
      margin-top: 20px;
      border: 1px solid rgba(52, 199, 89, 0.2);
      display: none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      animation: successSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .success-message-enhanced.show {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    @keyframes successSlideIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .success-icon {
      font-size: 18px;
      color: #34C759;
    }
    
    /* 页脚信息 */
    .login-footer {
      text-align: center;
      margin-top: 32px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 400;
      animation: fadeIn 1s ease-out 0.8s both;
    }
    
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    
    /* 响应式适配 */
    @media (max-width: 375px) {
      .login-container {
        padding: 0 16px;
      }
      
      .login-card {
        padding: 36px 24px;
        border-radius: 24px;
      }
      
      .app-title {
        font-size: 28px;
      }
      
      .app-logo {
        width: 72px;
        height: 72px;
        font-size: 28px;
      }
      
      .form-control-enhanced {
        padding: 16px 20px;
        padding-left: 52px;
        font-size: 16px;
      }
      
      .login-button {
        padding: 18px 20px;
        font-size: 17px;
      }
    }
    
    /* 横屏适配 */
    @media (orientation: landscape) and (max-height: 500px) {
      .login-main-container {
        padding: 16px;
      }
      
      .logo-section {
        margin-bottom: 24px;
      }
      
      .app-logo {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }
      
      .app-title {
        font-size: 24px;
      }
      
      .form-group-enhanced {
        margin-bottom: 20px;
      }
      
      .login-card {
        padding: 32px 28px;
      }
    }
    
    /* 深色模式支持 */
    @media (prefers-color-scheme: dark) {
      :root {
        --login-card-bg: rgba(28, 28, 30, 0.95);
        --login-input-bg: rgba(58, 58, 60, 0.8);
        --login-border: rgba(84, 84, 88, 0.4);
      }
      
      .form-label-enhanced {
        color: #ffffff;
      }
      
      .form-control-enhanced {
        color: #ffffff;
        border-color: var(--login-border);
      }
      
      .form-control-enhanced:focus {
        background: rgba(58, 58, 60, 1);
      }
      
      .form-control-enhanced::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }
      
      .app-title {
        color: #ffffff;
      }
      
      .app-subtitle {
        color: rgba(255, 255, 255, 0.8);
      }
    }
    
    /* 减少动画（用户偏好） */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      .login-card:hover {
        transform: none;
      }
      
      .login-button:hover {
        transform: none;
      }
      
      .app-logo:hover {
        transform: none;
      }
    }
    
    /* 高对比度模式 */
    @media (prefers-contrast: high) {
      .login-card {
        border: 3px solid var(--login-primary);
      }
      
      .form-control-enhanced {
        border: 3px solid var(--login-border);
      }
      
      .form-control-enhanced:focus {
        border: 3px solid var(--login-primary);
      }
      
      .login-button {
        border: 2px solid currentColor;
      }
    }
  </style>
</head>
<body>
  <div class="login-main-container" x-data="loginForm()" x-init="init()">
    <div class="login-container">
      <div class="login-card">
        <!-- Logo和标题区域 -->
        <div class="logo-section">
          <div class="app-logo">
            <i class="bi bi-book"></i>
          </div>
          <h1 class="app-title">图书借阅系统</h1>
          <p class="app-subtitle">欢迎回来，请登录您的账户</p>
        </div>
        
        <!-- 登录表单 -->
        <form class="login-form" @submit.prevent="handleSubmit()">
          <!-- 用户名输入 -->
          <div class="form-group-enhanced">
            <label class="form-label-enhanced">用户名</label>
            <div class="input-container">
              <input 
                type="text" 
                class="form-control-enhanced" 
                x-model="form.username" 
                placeholder="请输入用户名" 
                required 
                autofocus
                autocomplete="username"
                :disabled="loading"
                @input="clearError()"
                @focus="onInputFocus('username')"
                @blur="onInputBlur('username')"
              >
              <i class="bi bi-person input-icon"></i>
            </div>
          </div>
          
          <!-- 密码输入 -->
          <div class="form-group-enhanced">
            <label class="form-label-enhanced">密码</label>
            <div class="input-container">
              <input 
                :type="showPassword ? 'text' : 'password'"
                class="form-control-enhanced" 
                x-model="form.password" 
                placeholder="请输入密码" 
                required
                autocomplete="current-password"
                :disabled="loading"
                @input="clearError()"
                @focus="onInputFocus('password')"
                @blur="onInputBlur('password')"
                style="padding-right: 56px;"
              >
              <i class="bi bi-lock input-icon"></i>
              <button
                type="button"
                @click="togglePasswordVisibility()"
                style="position: absolute; right: 20px; background: none; border: none; color: #8e8e93; font-size: 18px; padding: 0; cursor: pointer; z-index: 1;"
                :disabled="loading"
              >
                <i :class="showPassword ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
              </button>
            </div>
          </div>
          
          <!-- 登录按钮 -->
          <button type="submit" class="login-button" :disabled="loading || !canSubmit">
            <span x-show="loading" class="loading-spinner-inline"></span>
            <span x-text="loading ? '登录中...' : '登录'"></span>
          </button>
        </form>
        
        <!-- 错误消息 -->
        <div class="error-message-enhanced" x-show="errorMessage" :class="{ 'show': errorMessage }">
          <i class="bi bi-exclamation-triangle error-icon"></i>
          <span x-text="errorMessage"></span>
        </div>
        
        <!-- 成功消息 -->
        <div class="success-message-enhanced" x-show="successMessage" :class="{ 'show': successMessage }">
          <i class="bi bi-check-circle success-icon"></i>
          <span x-text="successMessage"></span>
        </div>
      </div>
      
      <!-- 页脚信息 -->
      <div class="login-footer">
        © 2024 图书借阅系统 - 让阅读更简单
      </div>
    </div>
  </div>

  <script>
    function loginForm() {
      return {
        // 表单数据
        form: {
          username: '',
          password: ''
        },
        
        // 状态管理
        loading: false,
        showPassword: false,
        errorMessage: '',
        successMessage: '',
        
        // 表单验证状态
        validationErrors: {},
        focusedField: null,
        
        // 计算属性
        get canSubmit() {
          return this.form.username.trim() && 
                 this.form.password.trim() && 
                 !this.loading;
        },
        
        // 初始化
        init() {
          console.log('[登录页面] 初始化完成');
          
          // 检查是否已经登录
          this.checkExistingAuth();
          
          // 设置表单验证
          this.setupValidation();
          
          // 添加键盘快捷键
          this.setupKeyboardShortcuts();
        },
        
        // 检查现有认证
        async checkExistingAuth() {
          try {
            const response = await H5API.auth.getCurrentUser();
            if (response.success && response.user) {
              console.log('[登录页面] 用户已登录，跳转到主页');
              this.redirectToMain();
            }
          } catch (error) {
            // 用户未登录，继续显示登录页面
            console.log('[登录页面] 用户未登录');
          }
        },
        
        // 设置表单验证
        setupValidation() {
          // 实时验证规则
          this.$watch('form.username', (value) => {
            this.validateField('username', value);
          });
          
          this.$watch('form.password', (value) => {
            this.validateField('password', value);
          });
        },
        
        // 字段验证
        validateField(field, value) {
          switch (field) {
            case 'username':
              if (!value.trim()) {
                this.validationErrors.username = '请输入用户名';
              } else if (value.length < 2) {
                this.validationErrors.username = '用户名至少2个字符';
              } else {
                delete this.validationErrors.username;
              }
              break;
              
            case 'password':
              if (!value.trim()) {
                this.validationErrors.password = '请输入密码';
              } else if (value.length < 6) {
                this.validationErrors.password = '密码至少6个字符';
              } else {
                delete this.validationErrors.password;
              }
              break;
          }
        },
        
        // 设置键盘快捷键
        setupKeyboardShortcuts() {
          document.addEventListener('keydown', (e) => {
            // Enter键提交表单
            if (e.key === 'Enter' && this.canSubmit) {
              this.handleSubmit();
            }
            
            // Escape键清除错误
            if (e.key === 'Escape') {
              this.clearError();
            }
          });
        },
        
        // 处理表单提交
        async handleSubmit() {
          if (!this.canSubmit) {
            this.showValidationErrors();
            return;
          }
          
          console.log('[登录页面] 开始登录流程');
          
          this.loading = true;
          this.clearMessages();
          
          // 触觉反馈
          H5Utils.hapticFeedback('light');
          
          try {
            // 表单验证
            const validationResult = this.validateForm();
            if (!validationResult.valid) {
              this.showError(validationResult.message);
              return;
            }
            
            // 发送登录请求
            const response = await H5API.auth.login({
              username: this.form.username.trim(),
              password: this.form.password
            });
            
            if (response.success) {
              console.log('[登录页面] 登录成功');
              
              // 显示成功消息
              this.showSuccess('登录成功！正在跳转...');
              
              // 触觉反馈
              H5Utils.hapticFeedback('success');
              
              // 延迟跳转以显示成功动画
              setTimeout(() => {
                this.redirectToMain();
              }, 1500);
              
            } else {
              throw new Error(response.message || '登录失败');
            }
            
          } catch (error) {
            console.error('[登录页面] 登录失败:', error);
            
            // 处理不同类型的错误
            let errorMessage = '登录失败，请稍后重试';
            
            if (error.response?.status === 401) {
              errorMessage = '用户名或密码错误';
            } else if (error.response?.status === 429) {
              errorMessage = '登录尝试过于频繁，请稍后再试';
            } else if (error.message) {
              errorMessage = error.message;
            }
            
            this.showError(errorMessage);
            
            // 触觉反馈
            H5Utils.hapticFeedback('error');
            
            // 清空密码字段
            this.form.password = '';
            
          } finally {
            this.loading = false;
          }
        },
        
        // 表单验证
        validateForm() {
          const { username, password } = this.form;
          
          if (!username.trim()) {
            return { valid: false, message: '请输入用户名' };
          }
          
          if (username.trim().length < 2) {
            return { valid: false, message: '用户名至少需要2个字符' };
          }
          
          if (!password.trim()) {
            return { valid: false, message: '请输入密码' };
          }
          
          if (password.length < 6) {
            return { valid: false, message: '密码至少需要6个字符' };
          }
          
          return { valid: true };
        },
        
        // 显示验证错误
        showValidationErrors() {
          const errors = Object.values(this.validationErrors);
          if (errors.length > 0) {
            this.showError(errors[0]);
          }
        },
        
        // 切换密码可见性
        togglePasswordVisibility() {
          this.showPassword = !this.showPassword;
          H5Utils.hapticFeedback('light');
        },
        
        // 输入框焦点事件
        onInputFocus(field) {
          this.focusedField = field;
          this.clearError();
        },
        
        onInputBlur(field) {
          this.focusedField = null;
          this.validateField(field, this.form[field]);
        },
        
        // 清除错误消息
        clearError() {
          this.errorMessage = '';
        },
        
        // 清除所有消息
        clearMessages() {
          this.errorMessage = '';
          this.successMessage = '';
        },
        
        // 显示错误消息
        showError(message) {
          this.errorMessage = message;
          this.successMessage = '';
          
          // 自动隐藏错误消息
          setTimeout(() => {
            if (this.errorMessage === message) {
              this.errorMessage = '';
            }
          }, 5000);
        },
        
        // 显示成功消息
        showSuccess(message) {
          this.successMessage = message;
          this.errorMessage = '';
        },
        
        // 跳转到主页
        redirectToMain() {
          // 添加加载动画
          document.body.style.opacity = '0.5';
          document.body.style.transition = 'opacity 0.3s ease';
          
          setTimeout(() => {
            window.location.href = './h5-index.html';
          }, 300);
        },
        
        // 处理网络错误
        handleNetworkError(error) {
          if (!navigator.onLine) {
            this.showError('网络连接已断开，请检查网络设置');
          } else {
            this.showError('网络请求失败，请检查网络连接');
          }
        }
      }
    }
  </script>
</body>
</html>