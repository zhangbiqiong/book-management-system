<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>图书列表</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/less@4.2.0/dist/less.min.js"></script>
  <link rel="stylesheet/less" type="text/css" href="/h5/common.less" />
  <style>
    body { 
      padding-bottom: 80px; /* 为底部导航留出空间 */
    }
  </style>
    }
    
    .filter-tab.active:hover {
      background: #0b5ed7;
      color: #fff;
    }
    
    .sort-dropdown {
      position: relative;
    }
    
    .sort-button {
      padding: 0.5rem 1rem;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      background: #fff;
      color: #495057;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .sort-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
    }
    
    .sort-menu.show {
      display: block;
    }
    
    .sort-option {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f8f9fa;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .sort-option:hover {
      background: #f8f9fa;
    }
    
    .sort-option.active {
      background: #e7f3ff;
      color: #0d6efd;
    }
    
    .error-message { 
      background: #fee2e2; 
      border: 1px solid #fecaca; 
      color: #991b1b; 
      padding: 1rem; 
      border-radius: 0.5rem; 
      margin: 1rem 0; 
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .view-toggle {
      display: flex;
      gap: 0.25rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
      padding: 0.25rem;
    }
    
    .view-btn {
      padding: 0.5rem;
      border: none;
      background: transparent;
      border-radius: 0.25rem;
      color: #6c757d;
      transition: all 0.2s ease;
    }
    
    .view-btn.active {
      background: #fff;
      color: #0d6efd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body x-data="bookList()" x-init="init()">
  <div class="container py-3">
    <!-- 页面标题 -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0">图书列表</h5>
      <small class="text-muted" x-text="`共 ${totalBooks} 本图书`"></small>
    </div>

    <!-- 搜索框 -->
    <div class="search-box">
      <div class="input-group">
        <span class="input-group-text bg-transparent border-end-0">
          <i class="bi bi-search"></i>
        </span>
        <input 
          type="text" 
          class="form-control border-start-0" 
          placeholder="搜索图书名称或作者..."
          x-model="searchKeyword"
          @input.debounce.300ms="search()"
        >
      </div>
    </div>

    <!-- 子导航菜单 -->
    <div class="sub-nav">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <!-- 分类筛选 -->
        <div class="filter-tabs">
          <a href="#" 
             class="filter-tab" 
             :class="{ 'active': currentCategory === 'all' }"
             @click.prevent="filterByCategory('all')">
            全部
          </a>
          <a href="#" 
             class="filter-tab" 
             :class="{ 'active': currentCategory === 'education' }"
             @click.prevent="filterByCategory('education')">
            教育学
          </a>
          <a href="#" 
             class="filter-tab" 
             :class="{ 'active': currentCategory === 'literature' }"
             @click.prevent="filterByCategory('literature')">
            文学
          </a>
          <a href="#" 
             class="filter-tab" 
             :class="{ 'active': currentCategory === 'history' }"
             @click.prevent="filterByCategory('history')">
            历史学
          </a>
          <a href="#" 
             class="filter-tab" 
             :class="{ 'active': currentCategory === 'law' }"
             @click.prevent="filterByCategory('law')">
            法学
          </a>
          <a href="#" 
             class="filter-tab" 
             :class="{ 'active': currentCategory === 'science' }"
             @click.prevent="filterByCategory('science')">
            科学
          </a>
        </div>
      </div>
      
      <div class="d-flex justify-content-between align-items-center">
        <!-- 排序选项 -->
        <div class="sort-dropdown" x-data="{ open: false }">
          <button class="sort-button" @click="open = !open">
            <i class="bi bi-sort-down"></i>
            <span x-text="sortOptions[currentSort]"></span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <div class="sort-menu" :class="{ 'show': open }">
            <div class="sort-option" 
                 :class="{ 'active': currentSort === 'title' }"
                 @click="sortBy('title'); open = false">
              按书名排序
            </div>
            <div class="sort-option" 
                 :class="{ 'active': currentSort === 'author' }"
                 @click="sortBy('author'); open = false">
              按作者排序
            </div>
            <div class="sort-option" 
                 :class="{ 'active': currentSort === 'publish_date' }"
                 @click="sortBy('publish_date'); open = false">
              按出版年份排序
            </div>
            <div class="sort-option" 
                 :class="{ 'active': currentSort === 'stock' }"
                 @click="sortBy('stock'); open = false">
              按库存排序
            </div>
          </div>
        </div>
        
        <!-- 视图切换 -->
        <div class="view-toggle">
          <button class="view-btn" 
                  :class="{ 'active': viewMode === 'list' }"
                  @click="viewMode = 'list'">
            <i class="bi bi-list"></i>
          </button>
          <button class="view-btn" 
                  :class="{ 'active': viewMode === 'grid' }"
                  @click="viewMode = 'grid'">
            <i class="bi bi-grid"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- 错误信息显示 -->
    <template x-if="errorMessage">
      <div class="error-message">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span x-text="errorMessage"></span>
        <button class="btn btn-sm btn-outline-danger ms-2" @click="retry()">重试</button>
      </div>
    </template>

    <!-- 加载状态 -->
    <template x-if="loading">
      <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">正在加载图书列表...</p>
      </div>
    </template>

    <!-- 无图书显示 -->
    <template x-if="!loading && !errorMessage && books.length === 0">
      <div class="empty-state">
        <i class="bi bi-book"></i>
        <p class="mb-0">暂无图书</p>
        <small x-text="searchKeyword ? '没有找到匹配的图书' : '图书库为空'"></small>
      </div>
    </template>

    <!-- 图书列表 -->
    <template x-for="book in books" :key="book.id">
      <div class="book-item">
        <div class="book-title" x-text="book.title"></div>
        <div class="book-info">
          <i class="bi bi-person me-1"></i>
          <span x-text="book.author || '未知作者'"></span>
        </div>
        <div class="book-info">
          <i class="bi bi-tag me-1"></i>
          <span x-text="book.category || '未分类'"></span>
        </div>
        <div class="book-info">
          <i class="bi bi-calendar me-1"></i>
          <span x-text="book.publish_date ? new Date(book.publish_date).getFullYear() : '未知年份'"></span>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="book-stock" :class="stockClass(book)">
            <i class="bi bi-box me-1"></i>
            <span x-text="stockText(book)"></span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <small class="text-muted" x-text="`ISBN: ${book.isbn || '未知'}`"></small>
            <button 
              class="btn btn-primary btn-sm" 
              :disabled="book.stock <= 0"
              @click="borrowBook(book)"
              x-text="book.stock <= 0 ? '无库存' : '借阅'"
            ></button>
          </div>
        </div>
      </div>
    </template>

    <!-- 加载更多 -->
    <template x-if="hasMore && !loading && books.length > 0">
      <div class="text-center mt-3">
        <button class="btn btn-outline-primary btn-sm" @click="loadMore()" :disabled="loadingMore">
          <span x-text="loadingMore ? '加载中...' : '加载更多'"></span>
        </button>
      </div>
    </template>
  </div>

  <script>
    function bookList() {
      return {
        // 响应式数据
        books: [],
        loading: true,
        loadingMore: false,
        errorMessage: '',
        searchKeyword: '',
        currentPage: 1,
        pageSize: 20,
        totalBooks: 0,
        hasMore: true,
        
        // 新增的子导航数据
        currentCategory: 'all',
        currentSort: 'title',
        viewMode: 'list',
        sortOptions: {
          title: '按书名排序',
          author: '按作者排序',
          publish_date: '按出版年份排序',
          stock: '按库存排序'
        },
        
        // 初始化方法
        async init() {
          console.log('[图书页面] 初始化');
          this.loading = true;
          this.errorMessage = '';
          
          try {
            await this.loadBooks();
          } catch (error) {
            console.error('[图书页面] 初始化失败:', error);
            this.errorMessage = '页面初始化失败，请刷新重试';
          } finally {
            this.loading = false;
          }
        },
        
        // 加载图书列表
        async loadBooks(reset = true) {
          if (reset) {
            this.currentPage = 1;
            this.books = [];
            this.hasMore = true;
          }
          
          console.log('[图书页面] 加载图书列表，页码:', this.currentPage);
          
          try {
            const params = new URLSearchParams({
              page: this.currentPage,
              pageSize: this.pageSize
            });
            
            if (this.searchKeyword.trim()) {
              params.append('search', this.searchKeyword.trim());
            }
            
            if (this.currentCategory !== 'all') {
              params.append('category', this.currentCategory);
            }
            
            if (this.currentSort) {
              params.append('sort', this.currentSort);
            }
            
            const url = `/api/books?${params.toString()}`;
            console.log('[图书页面] 请求URL:', url);
            
            const response = await fetch(url, { 
              credentials: 'include',
              headers: { 'Accept': 'application/json' }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('[图书页面] 图书列表响应:', data);
            
            if (!data.success) {
              throw new Error(data.message || '获取图书列表失败');
            }
            
            const newBooks = data.data || [];
            this.totalBooks = data.pagination ? data.pagination.total : (data.total || 0);
            
            if (reset) {
              this.books = newBooks;
            } else {
              this.books.push(...newBooks);
            }
            
            this.hasMore = newBooks.length === this.pageSize;
            console.log('[图书页面] 成功加载图书数量:', newBooks.length);
            
          } catch (error) {
            console.error('[图书页面] 加载图书列表失败:', error);
            this.errorMessage = `加载图书列表失败: ${error.message}`;
          }
        },
        
        // 搜索图书
        async search() {
          console.log('[图书页面] 搜索图书:', this.searchKeyword);
          this.loading = true;
          this.errorMessage = '';
          
          try {
            await this.loadBooks(true);
          } catch (error) {
            console.error('[图书页面] 搜索失败:', error);
            this.errorMessage = `搜索失败: ${error.message}`;
          } finally {
            this.loading = false;
          }
        },
        
        // 按分类筛选
        async filterByCategory(category) {
          if (this.currentCategory === category) return;
          
          console.log('[图书页面] 按分类筛选:', category);
          this.currentCategory = category;
          this.loading = true;
          this.errorMessage = '';
          
          try {
            await this.loadBooks(true);
          } catch (error) {
            console.error('[图书页面] 分类筛选失败:', error);
            this.errorMessage = `分类筛选失败: ${error.message}`;
          } finally {
            this.loading = false;
          }
        },
        
        // 排序
        async sortBy(sortField) {
          if (this.currentSort === sortField) return;
          
          console.log('[图书页面] 排序:', sortField);
          this.currentSort = sortField;
          this.loading = true;
          this.errorMessage = '';
          
          try {
            await this.loadBooks(true);
          } catch (error) {
            console.error('[图书页面] 排序失败:', error);
            this.errorMessage = `排序失败: ${error.message}`;
          } finally {
            this.loading = false;
          }
        },
        
        // 加载更多
        async loadMore() {
          if (this.loadingMore || !this.hasMore) return;
          
          console.log('[图书页面] 加载更多图书');
          this.loadingMore = true;
          
          try {
            this.currentPage++;
            await this.loadBooks(false);
          } catch (error) {
            console.error('[图书页面] 加载更多失败:', error);
            this.currentPage--; // 回退页码
            this.errorMessage = `加载更多失败: ${error.message}`;
          } finally {
            this.loadingMore = false;
          }
        },
        
        // 重试方法
        async retry() {
          console.log('[图书页面] 用户点击重试');
          await this.init();
        },
        
        // 获取库存样式类
        stockClass(book) {
          const stock = book.stock || 0;
          if (stock === 0) return 'stock-out';
          if (stock <= 5) return 'stock-low';
          return 'stock-available';
        },
        
        // 获取库存文本
        stockText(book) {
          const stock = book.stock || 0;
          if (stock === 0) return '无库存';
          if (stock <= 5) return `库存紧张 (${stock})`;
          return `有库存 (${stock})`;
        },
        
        // 借阅图书
        async borrowBook(book) {
          if (book.stock <= 0) {
            alert('该图书无库存，无法借阅');
            return;
          }
          
          console.log('[图书页面] 借阅图书:', book.title);
          
          try {
            const response = await fetch('/api/borrows', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              credentials: 'include',
              body: JSON.stringify({
                bookId: book.id,
                borrowDate: new Date().toISOString().split('T')[0],
                expectedReturnDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 30天后
              })
            });
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
              alert(`借阅成功！图书《${book.title}》已添加到您的借阅记录中`);
              // 刷新图书列表以更新库存
              await this.loadBooks(true);
            } else {
              alert(`借阅失败: ${result.message || '未知错误'}`);
            }
          } catch (error) {
            console.error('[图书页面] 借阅失败:', error);
            alert(`借阅失败: ${error.message}`);
          }
        }
      }
    }
  </script>
</body>
</html>
