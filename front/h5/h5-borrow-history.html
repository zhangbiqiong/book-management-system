<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>我的借阅记录</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    body { background:#f8f9fa; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif; }
    .record-item { background:#fff; border-radius:0.75rem; padding:1rem; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin-bottom:1rem; }
    .record-header { font-weight:600; font-size:1rem; }
    .badge-status { font-size:0.75rem; padding:0.25rem 0.5rem; border-radius:0.5rem; }
    .status-borrowed { background:#dbeafe; color:#1e40af; }
    .status-overdue { background:#fee2e2; color:#991b1b; }
    .status-returned { background:#d1fae5; color:#065f46; }
    .btn-return { background:#10b981; border:none; font-size:0.8rem; }
    .btn-return:active { background:#059669 !important; }
  </style>
</head>
<body x-data="borrowHistory()" x-init="init()">
  <div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0">我的借阅记录</h5>
      <button class="btn btn-outline-secondary btn-sm" @click="logout()">退出登录</button>
    </div>

    <template x-if="loading">
      <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status"></div>
      </div>
    </template>

    <template x-if="!loading && records.length === 0">
      <p class="text-center text-muted mt-5">暂无借阅记录</p>
    </template>

    <template x-for="record in records" :key="record.id">
      <div class="record-item">
        <div class="d-flex justify-content-between align-items-start mb-1">
          <div class="record-header" x-text="record.bookTitle"></div>
          <span :class="statusClass(record)" class="badge-status" x-text="statusText(record)"></span>
        </div>
        <small class="text-muted">借阅日期：<span x-text="formatDate(record.borrowDate)"></span></small><br>
        <small class="text-muted">到期日期：<span x-text="formatDate(record.dueDate)"></span></small><br>
        <template x-if="record.returnDate">
          <small class="text-muted">归还日期：<span x-text="formatDate(record.returnDate)"></span></small>
        </template>
        <div class="mt-2" x-show="!record.returnDate">
          <button class="btn btn-return btn-sm text-white" @click="returnBook(record)" :disabled="submittingId === record.id">
            <i class="bi bi-check-circle me-1"></i>
            <span x-text="submittingId === record.id ? '处理中...' : '归还' "></span>
          </button>
        </div>
      </div>
    </template>
  </div>

  <script>
    function borrowHistory() {
      return {
        user: null,
        userId: null,
        records: [],
        loading: true,
        submittingId: 0,
        async init() {
          // 获取当前用户
          try {
            const res = await fetch('/api/current-user', { credentials: 'include' });
            const data = await res.json();
            if (!data.success) {
              window.location.href = '/h5/h5-login.html';
              return;
            }
            this.user = data.user;
            this.userId = data.user.id;
            await this.loadRecords();
          } catch (e) {
            window.location.href = '/h5/h5-login.html';
          }
        },
        async loadRecords() {
          this.loading = true;
          try {
            const res = await fetch(`/api/borrows?userId=${this.userId}&pageSize=100`, { credentials: 'include' });
            const data = await res.json();
            if (data.success) {
              this.records = (data.data || []).map(r => ({
                id: r.id,
                bookId: r.bookId,
                bookTitle: r.bookTitleDisplay || r.bookTitle,
                borrowerName: r.borrowerName,
                borrowDate: r.borrowDate,
                dueDate: r.dueDate,
                returnDate: r.returnDate,
                status: r.status
              }));
            } else {
              alert(data.message || '获取借阅记录失败');
            }
          } catch (e) {
            alert('网络错误，请稍后重试');
          } finally {
            this.loading = false;
          }
        },
        formatDate(dateStr) {
          if (!dateStr) return '--';
          try {
            return new Date(dateStr).toISOString().split('T')[0];
          } catch (e) { return dateStr; }
        },
        statusClass(r) {
          if (r.returnDate) return 'status-returned';
          const today = new Date();
          const due = new Date(r.dueDate);
          return today > due ? 'status-overdue' : 'status-borrowed';
        },
        statusText(r) {
          if (r.returnDate) return '已归还';
          const today = new Date();
          const due = new Date(r.dueDate);
          return today > due ? '逾期' : '借阅中';
        },
        async returnBook(record) {
          if (this.submittingId) return;
          this.submittingId = record.id;
          try {
            const today = new Date().toISOString().split('T')[0];
            const payload = {
              bookId: record.bookId,
              bookTitle: record.bookTitle,
              borrowerName: record.borrowerName,
              borrowDate: record.borrowDate,
              dueDate: record.dueDate,
              returnDate: today
            };
            const res = await fetch(`/api/borrows/${record.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.success) {
              record.returnDate = today;
            } else {
              alert(data.message || '归还失败');
            }
          } catch (e) {
            alert('网络错误，请稍后重试');
          } finally {
            this.submittingId = 0;
          }
        },
        async logout() {
          await fetch('/api/logout', { method: 'POST', credentials: 'include' });
          window.location.href = '/h5/h5-login.html';
        }
      }
    }
  </script>
</body>
</html>