<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据统计</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Apache ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.min.js"></script>
    <link rel="stylesheet/less" type="text/css" href="../common.less" />
    <script src="https://cdn.jsdelivr.net/npm/less" type="text/javascript"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- 公共JavaScript -->
    <script src="../common.js"></script>
    <style>
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }

        /* 响应式样式 */
        @media (max-width: 768px) {
            .chart-container {
                padding: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="main-content" x-data="statisticsManager()" x-init="init()">
        <!-- 借阅统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" x-text="borrowStats.total || '-'"></div>
                    <div class="stats-label">最近一个月总借阅量</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" x-text="borrowStats.avgDaily || '-'"></div>
                    <div class="stats-label">日均借阅量</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" x-text="borrowStats.maxDaily || '-'"></div>
                    <div class="stats-label">单日最高借阅量</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" x-text="returnStats.totalReturns || '-'"></div>
                    <div class="stats-label">最近一个月总归还量</div>
                </div>
            </div>
        </div>
        
        <!-- 归还统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-number" x-text="returnStats.avgDailyReturns || '-'"></div>
                    <div class="stats-label">日均归还量</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-number" x-text="returnStats.maxDailyReturns || '-'"></div>
                    <div class="stats-label">单日最高归还量</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-number" x-text="returnRate + '%'"></div>
                    <div class="stats-label">归还率</div>
                </div>
            </div>
        </div>

        <!-- 图表卡片 -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container mb-4">
                    <h4 class="mb-3">最近一个月借阅情况</h4>
                    <div id="borrowChart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container mb-4">
                    <h4 class="mb-3">最近一个月归还情况</h4>
                    <div id="returnChart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- 加载状态 -->
        <div x-show="loading" class="loading card card-body my-4" style="box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <div class="mt-2">正在加载统计数据...</div>
        </div>

        <!-- 错误状态 -->
        <div x-show="error" class="error card card-body my-4" style="box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <i class="bi bi-exclamation-triangle"></i>
            <div class="mt-2" x-text="errorMessage"></div>
            <button class="btn btn-primary mt-3" @click="loadStatistics()">重新加载</button>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function statisticsManager() {
            return {
                // 数据状态
                loading: false,
                error: false,
                errorMessage: '',
                initialized: false,
                
                // 统计数据
                borrowStats: {
                    total: 0,
                    avgDaily: 0,
                    maxDaily: 0,
                    days: []
                },
                returnStats: {
                    totalReturns: 0,
                    avgDailyReturns: 0,
                    maxDailyReturns: 0,
                    days: []
                },
                returnRate: 0,
                
                // 图表实例
                borrowChart: null,
                returnChart: null,

                // 初始化
                async init() {
                    try {
                        this.initialized = true;
                        await this.loadStatistics();
                    } catch (error) {
                        console.error('初始化失败:', error);
                        this.showError('初始化失败，请刷新页面重试');
                    }
                },

                // 加载统计数据
                async loadStatistics() {
                    try {
                        this.showLoading();

                        // 并行加载借阅和归还统计数据
                        const [borrowResponse, returnResponse] = await Promise.all([
                            fetch('/api/statistics/borrow'),
                            fetch('/api/statistics/return')
                        ]);

                        const borrowResult = await borrowResponse.json();
                        const returnResult = await returnResponse.json();

                        if (borrowResult.success && returnResult.success) {
                            this.updateBorrowStatistics(borrowResult.data);
                            this.updateReturnStatistics(returnResult.data);
                            this.calculateReturnRate();
                            this.renderBorrowChart();
                            this.renderReturnChart();
                            this.hideLoading();
                        } else {
                            const errorMessage = borrowResult.success ? returnResult.message : borrowResult.message;
                            this.showError(errorMessage || '获取统计数据失败');
                        }
                    } catch (error) {
                        console.error('加载统计数据错误:', error);
                        this.showError('网络错误，请检查连接');
                    }
                },

                // 更新借阅统计
                updateBorrowStatistics(data) {
                    this.borrowStats = {
                        total: data.total || 0,
                        avgDaily: data.days && data.days.length > 0 ? 
                            (data.total / data.days.length).toFixed(1) : 0,
                        maxDaily: data.days && data.days.length > 0 ? 
                            Math.max(...data.days.map(item => item.count)) : 0,
                        days: data.days || []
                    };
                },

                // 更新归还统计
                updateReturnStatistics(data) {
                    this.returnStats = {
                        totalReturns: data.totalReturns || 0,
                        avgDailyReturns: data.avgDailyReturns || 0,
                        maxDailyReturns: data.maxDailyReturns || 0,
                        days: data.days || []
                    };
                },

                // 计算归还率
                calculateReturnRate() {
                    const totalBorrows = this.borrowStats.total || 0;
                    const totalReturns = this.returnStats.totalReturns || 0;
                    
                    if (totalBorrows > 0) {
                        this.returnRate = ((totalReturns / totalBorrows) * 100).toFixed(1);
                    } else {
                        this.returnRate = 0;
                    }
                },

                // 渲染借阅图表
                renderBorrowChart() {
                    this.$nextTick(() => {
                        const chartDom = document.getElementById('borrowChart');
                        if (!chartDom) return;

                        if (this.borrowChart) {
                            this.borrowChart.dispose();
                        }
                        
                        this.borrowChart = echarts.init(chartDom, null, {
                            renderer: 'canvas',
                            useDirtyRect: false
                        });

                        const option = {
                            title: {
                                text: '最近一个月借阅情况统计',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'normal' }
                            },
                            tooltip: {
                                trigger: 'axis',
                                formatter: function (params) {
                                    const data = params[0];
                                    return `${data.name}<br/>借阅数量: ${data.value}`;
                                }
                            },
                            xAxis: {
                                type: 'category',
                                data: this.borrowStats.days.map(item => item.date), 
                                axisLabel: { rotate: 45, fontSize: 10 } 
                            },
                            yAxis: {
                                type: 'value',
                                name: '借阅数量',
                                minInterval: 1
                            },
                            series: [{
                                name: '借阅数量',
                                type: 'bar',
                                data: this.borrowStats.days.map(item => item.count), 
                                itemStyle: {
                                    color: '#007bff',
                                    borderRadius: [4, 4, 0, 0]
                                },
                                emphasis: {
                                    itemStyle: { color: '#0056b3' } 
                                }
                            }],
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '15%',
                                containLabel: true
                            }
                        };
                        this.borrowChart.setOption(option);
                        
                        // 监听窗口大小变化
                        window.addEventListener('resize', () => {
                            if (this.borrowChart) {
                                this.borrowChart.resize();
                            }
                        });
                    });
                },

                // 渲染归还图表
                renderReturnChart() {
                    this.$nextTick(() => {
                        const chartDom = document.getElementById('returnChart');
                        if (!chartDom) return;

                        if (this.returnChart) {
                            this.returnChart.dispose();
                        }
                        
                        this.returnChart = echarts.init(chartDom, null, {
                            renderer: 'canvas',
                            useDirtyRect: false
                        });

                        const option = {
                            title: {
                                text: '最近一个月归还情况统计',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'normal' }
                            },
                            tooltip: {
                                trigger: 'axis',
                                formatter: function (params) {
                                    const data = params[0];
                                    return `${data.name}<br/>归还数量: ${data.value}`;
                                }
                            },
                            xAxis: {
                                type: 'category',
                                data: this.returnStats.days.map(item => item.date), 
                                axisLabel: { rotate: 45, fontSize: 10 } 
                            },
                            yAxis: {
                                type: 'value',
                                name: '归还数量',
                                minInterval: 1
                            },
                            series: [{
                                name: '归还数量',
                                type: 'bar',
                                data: this.returnStats.days.map(item => item.count), 
                                itemStyle: {
                                    color: '#28a745',
                                    borderRadius: [4, 4, 0, 0]
                                },
                                emphasis: {
                                    itemStyle: { color: '#1e7e34' } 
                                }
                            }],
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '15%',
                                containLabel: true
                            }
                        };
                        this.returnChart.setOption(option);
                        
                        // 监听窗口大小变化
                        window.addEventListener('resize', () => {
                            if (this.returnChart) {
                                this.returnChart.resize();
                            }
                        });
                    });
                },

                // 显示加载状态
                showLoading() {
                    this.loading = true;
                    this.error = false;
                    this.errorMessage = '';
                },

                // 隐藏加载状态
                hideLoading() {
                    this.loading = false;
                },

                // 显示错误状态
                showError(message) {
                    this.loading = false;
                    this.error = true;
                    this.errorMessage = message;
                    this.showMessage(message, 'error');
                },

                // 使用统一的消息显示方法
                showMessage(message, type = 'success') {
                    CommonUtils.showMessage(message, type);
                }
            };
        }
    </script>
</body>

</html>