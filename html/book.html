<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>图书管理</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Flatpickr CSS -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
  <link rel="stylesheet/less" type="text/css" href="common.less" />
  <script src="https://cdn.jsdelivr.net/npm/less" type="text/javascript"></script>
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- 公共JavaScript -->
  <script src="common.js"></script>
  <style>
    .book-content {
      padding: 2rem;
    }
    
    /* 响应式样式 */
    @media (max-width: 768px) {
      .book-content { 
        padding: 1rem; 
      }
      .table-modern { 
        font-size: 0.9rem; 
      }
    }
  </style>
</head>

<body>
  <div class="book-content">
    <div x-data="bookManager()" x-init="init()">
      
      <!-- 统计卡片 -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="stats-card">
            <div class="stats-number" x-text="totalBooks"></div>
            <div class="stats-label">总图书数量</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <div class="stats-number" x-text="searchTerm ? total : totalBooks"></div>
            <div class="stats-label" x-text="searchTerm ? '搜索结果' : '当前页显示'"></div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <div class="stats-number" x-text="totalPages"></div>
            <div class="stats-label">总页数</div>
          </div>
        </div>
      </div>
      
      <!-- 搜索区域 -->
      <div class="search-section d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="position-relative flex-grow-1">
          <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
          <input type="text" class="form-control search-input ps-5" placeholder="搜索书名、作者或出版社..." x-model="searchTerm">
        </div>
        <div class="d-flex gap-2">

          <button class="btn btn-success-modern btn-modern" @click="openModal()" :disabled="loading">
            <i class="bi bi-plus-circle me-1"></i>添加图书
          </button>
        </div>
      </div>

      <!-- 图书表格 -->
      <div class="table-responsive">
        <table class="table table-modern">
          <thead>
            <tr>
              <th>书名</th>
              <th>作者</th>
              <th>出版社</th>
              <th>出版日期</th>
              <th>库存</th>
              <th>借阅</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="book in paginatedData" :key="`book-${book.id}`" x-show="initialized && !loading">
              <tr>
                <td x-text="book.title"></td>
                <td x-text="book.author"></td>
                <td x-text="book.publisher"></td>
                <td x-text="CommonUtils.formatDate(book.publish_date)"></td>
                <td x-text="book.stock"></td>
                <td x-text="getBorrowCount(book.id)"></td>
                <td>
                  <div class="d-flex gap-1">
                    <button class="btn btn-warning-modern btn-modern btn-sm" @click="openModal(book)" :disabled="loading">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-danger-modern btn-modern btn-sm" @click="openDeleteModal(book.id)" :disabled="loading">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </template>
            <!-- 初始化加载状态 -->
            <tr x-show="!initialized">
              <td colspan="7" class="empty-state">
                <div class="loading-spinner me-2"></div>初始化中...
              </td>
            </tr>
            <!-- 数据为空状态 -->
            <tr x-show="initialized && paginatedData.length === 0">
              <td colspan="7" class="empty-state">
                <span x-show="loading">
                  <div class="loading-spinner me-2"></div>加载中...
                </span>
                <span x-show="!loading">
                  <i class="bi bi-book"></i>
                  <div>暂无图书数据</div>
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 分页导航 -->
      <nav x-show="totalPages > 1" class="pagination-modern">
        <ul class="pagination justify-content-center">
          <!-- 上一页 -->
          <li class="page-item" :class="{ 'disabled': currentPage === 1 }">
            <a class="page-link" href="#" @click.prevent="goToPage(currentPage - 1)">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
          <!-- 页码 -->
          <template x-for="page in visiblePages" :key="page">
            <li class="page-item" :class="{ 'active': page === currentPage }">
              <a class="page-link" href="#" @click.prevent="goToPage(page)" x-text="page"></a>
            </li>
          </template>
          <!-- 下一页 -->
          <li class="page-item" :class="{ 'disabled': currentPage === totalPages }">
            <a class="page-link" href="#" @click.prevent="goToPage(currentPage + 1)">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>

      <!-- 添加/编辑图书模态框 -->
      <div class="modal modal-modern" x-show="showModal" x-cloak>
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" x-text="currentItem && currentItem.id ? '编辑图书' : '添加图书'"></h5>
              <button type="button" class="btn-close btn-close-white" @click="closeModal()"></button>
            </div>
            <form @submit.prevent="saveItem()">
              <div class="modal-body">
                <div class="form-group-horizontal">
                  <label class="form-label">书名 *</label>
                  <input type="text" class="form-control form-control-modern" x-model="currentItem.title" required>
                </div>
                <div class="form-group-horizontal">
                  <label class="form-label">作者 *</label>
                  <input type="text" class="form-control form-control-modern" x-model="currentItem.author" required>
                </div>
                <div class="form-group-horizontal">
                  <label class="form-label">出版社 *</label>
                  <input type="text" class="form-control form-control-modern" x-model="currentItem.publisher" required>
                </div>
                <div class="form-group-horizontal">
                  <label class="form-label">出版日期 *</label>
                  <input type="text" class="form-control form-control-modern" x-model="currentItem.publishDate" id="bookDate" required readonly>
                </div>
                <div class="form-group-horizontal">
                  <label class="form-label">库存 *</label>
                  <input type="number" class="form-control form-control-modern" x-model="currentItem.stock" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-modern" @click="closeModal()" :disabled="saving">取消</button>
                <button type="submit" class="btn btn-primary btn-modern" :disabled="saving">
                  <span x-show="saving" class="loading-spinner me-2"></span>
                  <span x-text="saving ? '保存中...' : '保存'"></span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 删除确认模态框 -->
      <div class="modal modal-modern" x-show="showDeleteModal" x-cloak>
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">确认删除</h5>
              <button type="button" class="btn-close btn-close-white" @click="closeDeleteModal()"></button>
            </div>
            <div class="modal-body">
              <p>确定要删除这本图书吗？删除后无法恢复。</p>
              <p class="text-muted" x-text="currentItem ? `书名: ${currentItem.title}` : ''"></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-modern" @click="closeDeleteModal()" :disabled="deleting">取消</button>
              <button type="button" class="btn btn-danger-modern btn-modern" @click="deleteItem()" :disabled="deleting">
                <span x-show="deleting" class="loading-spinner me-2"></span>
                <span x-text="deleting ? '删除中...' : '确认删除'"></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Flatpickr JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/zh.js"></script>

  <script>
    // 图书管理Alpine.js组件
    function bookManager() {
      const baseManager = createBaseDataManager();
      return {
        // 继承基础数据管理功能
        ...baseManager,
        
        // 确保数据初始化
        data: [],
        filteredData: [],
        initialized: false, // 初始化状态标志
        
        // 图书特有的数据
        total: 0, // 搜索结果总数
        totalBooks: 0, // 数据库中所有图书的总数
        borrows: [], // 借阅数据
        
        // 重写计算属性，因为API已经分页
        get paginatedData() {
          // 在初始化完成前返回空数组，避免渲染错误
          if (!this.initialized) {
            return [];
          }
          return this.data || [];
        },
        
        get totalPages() {
          return Math.ceil(this.total / this.pageSize);
        },
        
        get visiblePages() {
          const pages = [];
          const start = Math.max(1, this.currentPage - 3);
          const end = Math.min(this.totalPages, this.currentPage + 3);
          for (let i = start; i <= end; i++) {
            pages.push(i);
          }
          return pages;
        },
        
        async loadData() {
          try {
            this.loading = true;
            const url = new URL('/api/books', window.location.origin);
            url.searchParams.set('search', this.searchTerm);
            url.searchParams.set('page', this.currentPage);
            url.searchParams.set('pageSize', this.pageSize);

            const result = await this.apiCall(url.toString());
            if (result.success) {
              const rawData = result.data || [];
              
              // 验证和清理数据，确保每个 book 都有有效的 id
              this.data = rawData.filter(book => {
                if (!book || !book.id) {
                  console.warn('发现无效的图书数据:', book);
                  return false;
                }
                return true;
              }).map(book => ({
                ...book,
                id: String(book.id) // 确保 id 是字符串
              }));
              
              // 检查重复的 id
              const ids = this.data.map(book => book.id);
              const uniqueIds = [...new Set(ids)];
              if (ids.length !== uniqueIds.length) {
                console.warn('发现重复的图书 ID');
                // 去重，保留第一个
                const seenIds = new Set();
                this.data = this.data.filter(book => {
                  if (seenIds.has(book.id)) {
                    return false;
                  }
                  seenIds.add(book.id);
                  return true;
                });
              }
              
              this.total = result.pagination ? result.pagination.total : (result.total || 0);
              this.filteredData = [...this.data];
              
              console.log('处理后的数据:', this.data.length, '条记录');
              
              // 如果没有搜索词，当前的total就是总图书数
              if (!this.searchTerm.trim()) {
                this.totalBooks = this.total;
              }
            } else {
              this.showMessage(result.message || '加载失败', 'error');
            }
          } catch (error) {
            this.showMessage('网络错误', 'error');
          } finally {
            this.loading = false;
          }
        },
        
        // 加载总图书数
        async loadTotalBooks() {
          try {
            // 获取所有图书的总数（不使用搜索参数）
            const res = await fetch('/api/books?pageSize=1&search=');
            const data = await res.json();
            if (data.success) {
              this.totalBooks = data.pagination ? data.pagination.total : (data.total || 0);
              console.log('总图书数:', this.totalBooks);
            }
          } catch (e) {
            console.error('加载总图书数失败:', e);
            this.totalBooks = 0;
          }
        },

        // 加载借阅数据
        async loadBorrows() {
          try {
            const result = await this.apiCall('/api/borrows?pageSize=1000');
            if (result.success) {
              this.borrows = result.data || [];
            } else {
              console.error('加载借阅数据失败:', result.message);
              this.borrows = [];
            }
          } catch (e) {
            console.error('加载借阅数据失败:', e);
            this.borrows = [];
          }
        },

        // 获取图书的借阅数量
        getBorrowCount(bookId) {
          if (!this.borrows || this.borrows.length === 0) {
            return 0;
          }
          // 统计该图书的所有借阅记录（包括已归还和未归还的）
          // 确保类型匹配，将两个ID都转换为字符串进行比较
          return this.borrows.filter(borrow => String(borrow.bookId) === String(bookId)).length;
        },

        // 重写init方法
        async init() {
          try {
            // 确保数据初始化
            this.data = [];
            this.filteredData = [];
            this.total = 0;
            this.totalBooks = 0;
            this.borrows = [];
            this.initialized = false;
            
            // 初始化currentItem为空项
            this.currentItem = this.getEmptyItem();
            
            // 并行加载图书数据和借阅数据
            await Promise.all([
              this.loadData(),
              this.loadBorrows()
            ]);
            
            // 设置初始化完成标志
            this.initialized = true;
            
            // 加载总数
            this.loadTotalBooks();
            
            // 设置搜索
            this.setupSearch();
            
            console.log('图书管理组件初始化完成');
          } catch (error) {
            console.error('初始化失败:', error);
            this.initialized = true; // 即使失败也设置为true，避免界面卡住
          }
        },

        // 重写openModal方法，添加日期选择器初始化
        openModal(item = null) {
          this.currentItem = item ? { ...item } : this.getEmptyItem();
          this.showModal = true;
          this.$nextTick(() => {
            if (window.flatpickr) {
              flatpickr('#bookDate', { 
                dateFormat: 'Y-m-d', 
                locale: 'zh', 
                allowInput: false, 
                clickOpens: true,
                onChange: (selectedDates, dateStr) => { 
                  this.currentItem.publishDate = dateStr; 
                }
              });
            }
          });
        },
        
        // 重写搜索设置
        setupSearch() {
          this.$watch('searchTerm', CommonUtils.debounce(async () => {
            this.currentPage = 1; // 搜索时重置到第一页
            await this.loadData(); // 调用API而不是前端过滤
          }, 300));
        },
        
        // 重写分页方法
        async goToPage(page) {
          if (page >= 1 && page <= this.totalPages) {
            this.currentPage = page;
            await this.loadData(); // 调用API获取对应页面数据
          }
        },
        
        async nextPage() {
          if (this.currentPage < this.totalPages) {
            this.currentPage++;
            await this.loadData();
          }
        },
        
        async prevPage() {
          if (this.currentPage > 1) {
            this.currentPage--;
            await this.loadData();
          }
        },

        async saveItem() {
          if (!this.currentItem.title || !this.currentItem.author || !this.currentItem.publisher || !this.currentItem.publishDate || !this.currentItem.stock) {
            this.showMessage('请填写所有必填字段', 'error');
            return;
          }

          try {
            this.saving = true;
            const isEdit = this.currentItem.id;
            const url = isEdit ? `/api/books/${this.currentItem.id}` : '/api/books';
            const method = isEdit ? 'PUT' : 'POST';

            const result = await this.apiCall(url, {
              method,
              body: JSON.stringify(this.currentItem)
            });

            if (result.success) {
              this.showMessage(isEdit ? '图书更新成功' : '图书添加成功', 'success');
              this.closeModal();
              await this.loadData();
              // 重新加载借阅数据以更新借阅数量
              await this.loadBorrows();
              // 如果是添加新图书且没有搜索条件，更新总数
              if (!isEdit && !this.searchTerm.trim()) {
                this.loadTotalBooks();
              }
            } else {
              this.showMessage(result.message || '操作失败', 'error');
            }
          } catch (error) {
            this.showMessage('网络错误', 'error');
          } finally {
            this.saving = false;
          }
        },

        async deleteItem() {
          try {
            this.deleting = true;
            const result = await this.apiCall(`/api/books/${this.deleteItemId}`, {
              method: 'DELETE'
            });

            if (result.success) {
              this.showMessage('图书删除成功', 'success');
              this.closeDeleteModal();
              await this.loadData();
              // 重新加载借阅数据以更新借阅数量
              await this.loadBorrows();
              // 只有在没有搜索条件时才更新总数
              if (!this.searchTerm.trim()) {
                this.loadTotalBooks();
              }
            } else {
              this.showMessage(result.message || '删除失败', 'error');
            }
          } catch (error) {
            this.showMessage('网络错误', 'error');
          } finally {
            this.deleting = false;
          }
        },

        getEmptyItem() {
          return {
            title: '',
            author: '',
            publisher: '',
            publishDate: '',
            stock: 0
          };
        },

        resetForm() {
          this.currentItem = this.getEmptyItem();
        }
      };
    }
  </script>
</body>

</html>