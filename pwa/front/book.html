<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  
  <title>图书列表 - 图书借阅系统</title>
  
  <!-- 指定技术栈CDN资源 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/less@4.2.0/dist/less.min.js"></script>
  
  <!-- 公共样式和脚本 -->
  <link rel="stylesheet/less" type="text/css" href="./common.less" />
  <script src="./common.js"></script>
  
  <!-- Alpine.js必须在common.js之后加载 -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
  
  <style>
    /* 专门为图书页面的样式增强 */
    :root {
      --book-card-bg: rgba(255, 255, 255, 0.95);
      --search-bg: rgba(242, 242, 247, 0.8);
      --filter-active: #007AFF;
      --filter-bg: rgba(0, 122, 255, 0.1);
      --status-available: #34C759;
      --status-borrowed: #FF9500;
      --status-unavailable: #FF3B30;
    }
    
    /* 页面主容器 */
    .book-page-container {
      min-height: 100vh;
      min-height: 100dvh;
      background: var(--background-grouped, #F2F2F7);
      padding-top: env(safe-area-inset-top, 12px);
      padding-bottom: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
    }
    
    /* 页面头部 */
    .page-header {
      position: sticky;
      top: env(safe-area-inset-top, 0);
      background: rgba(242, 242, 247, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 100;
      padding: 16px 20px 12px 20px;
      border-bottom: 0.5px solid rgba(60, 60, 67, 0.1);
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #1C1C1E;
      margin: 0 0 16px 0;
      letter-spacing: -0.5px;
    }
    
    /* 增强的搜索栏 */
    .enhanced-search-container {
      position: relative;
      margin-bottom: 16px;
    }
    
    .enhanced-search-bar {
      display: flex;
      align-items: center;
      background: var(--search-bg);
      border-radius: 12px;
      padding: 12px 16px;
      transition: all 0.3s ease-out;
      border: 1px solid transparent;
    }
    
    .enhanced-search-bar:focus-within {
      background: rgba(255, 255, 255, 1);
      border-color: var(--filter-active);
      box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
      transform: translateY(-1px);
    }
    
    .search-icon {
      color: #8E8E93;
      font-size: 18px;
      margin-right: 12px;
      transition: color 0.3s ease;
    }
    
    .enhanced-search-bar:focus-within .search-icon {
      color: var(--filter-active);
    }
    
    .search-input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 17px;
      color: #1C1C1E;
      font-family: inherit;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .search-input::placeholder {
      color: #8E8E93;
    }
    
    .search-clear-btn {
      background: #8E8E93;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-clear-btn.show {
      opacity: 1;
    }
    
    .search-clear-btn:hover {
      background: #666;
    }
    
    /* 过滤标签 */
    .filter-container {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .filter-container::-webkit-scrollbar {
      display: none;
    }
    
    .filter-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.8);
      color: #8E8E93;
      text-decoration: none;
      white-space: nowrap;
      font-size: 15px;
      font-weight: 500;
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease-out;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }
    
    .filter-tag:hover {
      background: rgba(255, 255, 255, 1);
      color: #1C1C1E;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .filter-tag.active {
      background: var(--filter-bg);
      color: var(--filter-active);
      border-color: var(--filter-active);
    }
    
    .filter-tag.active:hover {
      background: rgba(0, 122, 255, 0.15);
      color: var(--filter-active);
    }
    
    .filter-icon {
      font-size: 14px;
    }
    
    /* 内容区域 */
    .content-container {
      padding: 0 20px;
    }
    
    /* 工具栏 */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 4px;
    }
    
    .results-info {
      font-size: 15px;
      color: #8E8E93;
      font-weight: 500;
    }
    
    .view-toggle {
      display: flex;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      padding: 4px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .view-btn {
      background: none;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      color: #8E8E93;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
    }
    
    .view-btn.active {
      background: var(--filter-active);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }
    
    /* 图书列表 */
    .books-list {
      display: grid;
      gap: 16px;
      margin-bottom: 40px;
    }
    
    .books-list.grid-view {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    
    .books-list.list-view {
      grid-template-columns: 1fr;
    }
    
    /* 图书卡片 */
    .book-card {
      background: var(--book-card-bg);
      border-radius: 16px;
      padding: 20px;
      border: 0.5px solid rgba(60, 60, 67, 0.1);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    
    .book-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      border-color: rgba(0, 122, 255, 0.2);
    }
    
    .book-card:active {
      transform: translateY(0) scale(0.98);
    }
    
    /* 图书信息 */
    .book-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .book-title {
      font-size: 18px;
      font-weight: 600;
      color: #1C1C1E;
      margin: 0 0 4px 0;
      line-height: 1.3;
      letter-spacing: -0.2px;
      flex: 1;
      margin-right: 12px;
    }
    
    .book-status {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.2px;
      text-transform: uppercase;
      flex-shrink: 0;
    }
    
    .book-status.available {
      background: rgba(52, 199, 89, 0.1);
      color: var(--status-available);
    }
    
    .book-status.borrowed {
      background: rgba(255, 149, 0, 0.1);
      color: var(--status-borrowed);
    }
    
    .book-status.unavailable {
      background: rgba(255, 59, 48, 0.1);
      color: var(--status-unavailable);
    }
    
    .status-icon {
      font-size: 10px;
    }
    
    .book-meta {
      margin-bottom: 16px;
    }
    
    .book-author {
      font-size: 15px;
      color: #8E8E93;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .book-category {
      font-size: 13px;
      color: #8E8E93;
      background: rgba(142, 142, 147, 0.1);
      padding: 2px 8px;
      border-radius: 8px;
      display: inline-block;
    }
    
    .book-description {
      font-size: 14px;
      color: #666;
      line-height: 1.4;
      margin-bottom: 16px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .book-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #8E8E93;
    }
    
    .detail-icon {
      font-size: 12px;
      width: 14px;
      text-align: center;
    }
    
    /* 操作按钮 */
    .book-actions {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }
    
    .action-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease-out;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-height: 44px;
    }
    
    .action-btn.primary {
      background: var(--filter-active);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    
    .action-btn.primary:hover {
      background: #0056CC;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0, 122, 255, 0.4);
    }
    
    .action-btn.primary:active {
      transform: translateY(0);
    }
    
    .action-btn.secondary {
      background: rgba(142, 142, 147, 0.1);
      color: #8E8E93;
      border: 1px solid rgba(142, 142, 147, 0.2);
    }
    
    .action-btn.secondary:hover {
      background: rgba(142, 142, 147, 0.15);
      color: #666;
    }
    
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* 加载更多 */
    .load-more-container {
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    
    .load-more-btn {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      padding: 12px 24px;
      color: var(--filter-active);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .load-more-btn:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* 空状态 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8E8E93;
    }
    
    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.6;
    }
    
    .empty-title {
      font-size: 20px;
      font-weight: 600;
      color: #1C1C1E;
      margin-bottom: 8px;
    }
    
    .empty-message {
      font-size: 16px;
      line-height: 1.4;
      margin-bottom: 24px;
    }
    
    .empty-action {
      background: var(--filter-active);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .empty-action:hover {
      background: #0056CC;
      transform: translateY(-1px);
    }
    
    /* 下拉刷新 */
    .pull-refresh-indicator {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 0 0 12px 12px;
      padding: 8px 20px;
      font-size: 14px;
      color: #8E8E93;
      z-index: 1000;
      transition: all 0.3s ease;
      opacity: 0;
      pointer-events: none;
    }
    
    .pull-refresh-indicator.show {
      opacity: 1;
    }
    
    /* 响应式设计 */
    @media (max-width: 375px) {
      .page-header {
        padding: 12px 16px 8px 16px;
      }
      
      .page-title {
        font-size: 24px;
      }
      
      .content-container {
        padding: 0 16px;
      }
      
      .books-list.grid-view {
        grid-template-columns: 1fr;
      }
      
      .book-card {
        padding: 16px;
      }
      
      .book-title {
        font-size: 16px;
      }
      
      .book-details {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }
    
    /* 横屏适配 */
    @media (orientation: landscape) and (max-height: 500px) {
      .page-header {
        position: relative;
        padding: 8px 20px;
      }
      
      .page-title {
        font-size: 22px;
        margin-bottom: 8px;
      }
      
      .book-card {
        padding: 12px;
      }
    }
    
    /* 深色模式支持 */
    @media (prefers-color-scheme: dark) {
      :root {
        --book-card-bg: rgba(28, 28, 30, 0.95);
        --search-bg: rgba(58, 58, 60, 0.8);
      }
      
      .book-page-container {
        background: #000000;
      }
      
      .page-header {
        background: rgba(0, 0, 0, 0.95);
        border-bottom-color: rgba(84, 84, 88, 0.2);
      }
      
      .page-title {
        color: #FFFFFF;
      }
      
      .enhanced-search-bar:focus-within {
        background: rgba(58, 58, 60, 1);
      }
      
      .search-input {
        color: #FFFFFF;
      }
      
      .search-input::placeholder {
        color: rgba(235, 235, 245, 0.6);
      }
      
      .filter-tag {
        background: rgba(58, 58, 60, 0.8);
        color: rgba(235, 235, 245, 0.8);
        border-color: rgba(84, 84, 88, 0.2);
      }
      
      .filter-tag:hover {
        background: rgba(58, 58, 60, 1);
        color: #FFFFFF;
      }
      
      .book-title {
        color: #FFFFFF;
      }
      
      .empty-title {
        color: #FFFFFF;
      }
    }
    
    /* 减少动画（用户偏好） */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      .book-card:hover {
        transform: none;
      }
      
      .action-btn:hover {
        transform: none;
      }
    }
  </style>
</head>
<body x-data="bookPage()" x-init="init()">
  <div class="book-page-container">
    <!-- 页面头部 -->
    <div class="page-header">
      <h1 class="page-title">图书馆</h1>
      
      <!-- 增强的搜索栏 -->
      <div class="enhanced-search-container">
        <div class="enhanced-search-bar">
          <i class="bi bi-search search-icon"></i>
          <input 
            type="text" 
            class="search-input" 
            placeholder="搜索图书、作者或ISBN"
            x-model="searchQuery"
            @input="onSearchInput()"
            @keyup.enter="performSearch()"
          >
          <button 
            class="search-clear-btn"
            :class="{ 'show': searchQuery }"
            @click="clearSearch()"
          >
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>
      
      <!-- 过滤标签 -->
      <div class="filter-container">
        <a href="#" 
           class="filter-tag"
           :class="{ 'active': activeFilter === 'all' }"
           @click.prevent="setFilter('all')">
          <i class="bi bi-list filter-icon"></i>
          全部
        </a>
        <a href="#" 
           class="filter-tag"
           :class="{ 'active': activeFilter === 'available' }"
           @click.prevent="setFilter('available')">
          <i class="bi bi-check-circle filter-icon"></i>
          可借阅
        </a>
        <a href="#" 
           class="filter-tag"
           :class="{ 'active': activeFilter === 'popular' }"
           @click.prevent="setFilter('popular')">
          <i class="bi bi-fire filter-icon"></i>
          热门
        </a>
        <a href="#" 
           class="filter-tag"
           :class="{ 'active': activeFilter === 'new' }"
           @click.prevent="setFilter('new')">
          <i class="bi bi-star filter-icon"></i>
          新书
        </a>
        <template x-for="category in categories" :key="category.id">
          <a href="#" 
             class="filter-tag"
             :class="{ 'active': activeFilter === category.id }"
             @click.prevent="setFilter(category.id)"
             x-text="category.name">
          </a>
        </template>
      </div>
    </div>
    
    <!-- 内容区域 -->
    <div class="content-container">
      <!-- 工具栏 -->
      <div class="toolbar">
        <div class="results-info">
          <template x-if="!loading && books.length > 0">
            <span x-text="`共找到 ${total} 本图书`"></span>
          </template>
          <template x-if="!loading && books.length === 0 && !firstLoad">
            <span>未找到相关图书</span>
          </template>
        </div>
        
        <div class="view-toggle">
          <button 
            class="view-btn"
            :class="{ 'active': viewMode === 'grid' }"
            @click="setViewMode('grid')"
          >
            <i class="bi bi-grid"></i>
          </button>
          <button 
            class="view-btn"
            :class="{ 'active': viewMode === 'list' }"
            @click="setViewMode('list')"
          >
            <i class="bi bi-list"></i>
          </button>
        </div>
      </div>
      
      <!-- 图书列表 -->
      <div 
        class="books-list"
        :class="viewMode === 'grid' ? 'grid-view' : 'list-view'"
        x-show="books.length > 0"
      >
        <template x-for="book in books" :key="book.id">
          <div class="book-card" @click="showBookDetail(book)">
            <div class="book-header">
              <h3 class="book-title" x-text="book.title"></h3>
              <div 
                class="book-status"
                :class="getStatusClass(book.status)"
              >
                <i class="bi status-icon" :class="getStatusIcon(book.status)"></i>
                <span x-text="getStatusText(book.status)"></span>
              </div>
            </div>
            
            <div class="book-meta">
              <div class="book-author" x-text="book.author"></div>
              <span class="book-category" x-text="book.category"></span>
            </div>
            
            <div class="book-description" x-text="book.description"></div>
            
            <div class="book-details">
              <div class="detail-item">
                <i class="bi bi-bookmark detail-icon"></i>
                <span x-text="book.isbn"></span>
              </div>
              <div class="detail-item">
                <i class="bi bi-calendar detail-icon"></i>
                <span x-text="book.publishYear"></span>
              </div>
              <div class="detail-item">
                <i class="bi bi-building detail-icon"></i>
                <span x-text="book.publisher"></span>
              </div>
              <div class="detail-item">
                <i class="bi bi-stack detail-icon"></i>
                <span x-text="`库存: ${book.stock}`"></span>
              </div>
            </div>
            
            <div class="book-actions">
              <template x-if="book.status === 'available'">
                <button 
                  class="action-btn primary"
                  @click.stop="borrowBook(book)"
                  :disabled="borrowing[book.id]"
                >
                  <template x-if="borrowing[book.id]">
                    <i class="bi bi-arrow-clockwise spinning"></i>
                  </template>
                  <template x-if="!borrowing[book.id]">
                    <i class="bi bi-download"></i>
                  </template>
                  <span x-text="borrowing[book.id] ? '借阅中...' : '立即借阅'"></span>
                </button>
              </template>
              
              <template x-if="book.status !== 'available'">
                <button class="action-btn secondary" disabled>
                  <i class="bi bi-x-circle"></i>
                  <span>暂不可借</span>
                </button>
              </template>
              
              <button 
                class="action-btn secondary"
                @click.stop="showBookDetail(book)"
              >
                <i class="bi bi-info-circle"></i>
                <span>详情</span>
              </button>
            </div>
          </div>
        </template>
      </div>
      
      <!-- 加载更多 -->
      <div class="load-more-container" x-show="hasMore && books.length > 0">
        <button 
          class="load-more-btn"
          @click="loadMore()"
          :disabled="loading"
        >
          <template x-if="loading">
            <i class="bi bi-arrow-clockwise spinning"></i>
          </template>
          <template x-if="!loading">
            <i class="bi bi-arrow-down-circle"></i>
          </template>
          <span x-text="loading ? '加载中...' : '加载更多'"></span>
        </button>
      </div>
      
      <!-- 空状态 -->
      <div class="empty-state" x-show="!loading && books.length === 0 && !firstLoad">
        <div class="empty-icon">
          <i class="bi bi-book"></i>
        </div>
        <h3 class="empty-title">暂无图书</h3>
        <p class="empty-message">
          <template x-if="searchQuery">
            没有找到与 "<span x-text="searchQuery"></span>" 相关的图书
          </template>
          <template x-if="!searchQuery">
            当前分类下暂无图书，试试其他分类吧
          </template>
        </p>
        <button class="empty-action" @click="refreshBooks()">
          <i class="bi bi-arrow-clockwise"></i>
          刷新页面
        </button>
      </div>
    </div>
  </div>
  
  <!-- 下拉刷新指示器 -->
  <div class="pull-refresh-indicator" x-show="refreshing">
    <i class="bi bi-arrow-clockwise spinning"></i>
    正在刷新...
  </div>

  <script>
    function bookPage() {
      return {
        ...H5Components.pagination(),
        ...H5Components.pullToRefresh(),
        ...H5Components.searchBar(),
        
        // 数据状态
        books: [],
        categories: [],
        total: 0,
        
        // UI状态
        loading: false,
        firstLoad: true,
        refreshing: false,
        viewMode: 'grid',
        activeFilter: 'all',
        borrowing: {},
        
        // 搜索状态
        searchQuery: '',
        searchTimeout: null,
        
        // 分页状态（继承自pagination mixin）
        
        // 初始化
        async init() {
          console.log('[图书页面] 初始化');
          
          try {
            // 设置下拉刷新
            this.setupPullToRefresh();
            
            // 设置无限滚动
            this.setupInfiniteScroll();
            
            // 加载分类数据
            await this.loadCategories();
            
            // 加载图书数据
            await this.loadBooks();
            
            // 恢复用户偏好设置
            this.restoreUserPreferences();
            
            console.log('[图书页面] 初始化完成');
            
          } catch (error) {
            console.error('[图书页面] 初始化失败:', error);
            H5Toast.error('页面加载失败，请刷新重试');
          } finally {
            this.firstLoad = false;
          }
        },
        
        // 加载分类
        async loadCategories() {
          try {
            const response = await H5API.books.getCategories();
            if (response.success) {
              this.categories = response.categories || [];
            }
          } catch (error) {
            console.error('[图书页面] 分类加载失败:', error);
          }
        },
        
        // 加载图书数据（覆盖 pagination mixin 的方法）
        async loadData() {
          return this.loadBooks();
        },
        
        // 加载图书
        async loadBooks(append = false) {
          if (this.loading) return;
          
          this.loading = true;
          
          try {
            const params = {
              page: this.currentPage,
              limit: this.pageSize,
              filter: this.activeFilter,
              search: this.searchQuery.trim(),
              sort: 'updated_desc'
            };
            
            const response = await H5API.books.list(params);
            
            if (response.success) {
              const newBooks = response.books || [];
              
              if (append) {
                this.books.push(...newBooks);
              } else {
                this.books = newBooks;
              }
              
              // 更新分页信息
              this.updatePagination(response);
              
              console.log(`[图书页面] 加载了 ${newBooks.length} 本图书`);
              
            } else {
              throw new Error(response.message || '加载失败');
            }
            
          } catch (error) {
            console.error('[图书页面] 图书加载失败:', error);
            
            if (this.books.length === 0) {
              H5Toast.error('图书加载失败，请检查网络连接');
            }
          } finally {
            this.loading = false;
          }
        },
        
        // 搜索相关方法（覆盖 searchBar mixin 的方法）
        async search(query) {
          console.log('[图书页面] 搜索:', query);
          this.reset();
          this.currentPage = 1;
          await this.loadBooks();
        },
        
        onSearchInput() {
          clearTimeout(this.searchTimeout);
          this.searchTimeout = setTimeout(() => {
            if (this.searchQuery.trim()) {
              this.performSearch();
            } else {
              this.clearSearch();
            }
          }, 500);
        },
        
        async performSearch() {
          if (!this.searchQuery.trim()) return;
          
          H5Utils.hapticFeedback('light');
          await this.search(this.searchQuery.trim());
        },
        
        clearSearch() {
          this.searchQuery = '';
          this.clearResults();
          this.reset();
          this.currentPage = 1;
          this.loadBooks();
          H5Utils.hapticFeedback('light');
        },
        
        // 过滤相关
        async setFilter(filter) {
          if (this.activeFilter === filter) return;
          
          console.log('[图书页面] 设置过滤器:', filter);
          
          this.activeFilter = filter;
          this.reset();
          this.currentPage = 1;
          
          H5Utils.hapticFeedback('light');
          await this.loadBooks();
          
          // 保存用户偏好
          this.saveUserPreferences();
        },
        
        // 视图模式
        setViewMode(mode) {
          if (this.viewMode === mode) return;
          
          this.viewMode = mode;
          H5Utils.hapticFeedback('light');
          
          // 保存用户偏好
          this.saveUserPreferences();
        },
        
        // 借阅图书
        async borrowBook(book) {
          if (this.borrowing[book.id] || book.status !== 'available') {
            return;
          }
          
          console.log('[图书页面] 借阅图书:', book.title);
          
          // 设置借阅状态
          this.borrowing[book.id] = true;
          
          H5Utils.hapticFeedback('light');
          
          try {
            const response = await H5API.books.borrow(book.id);
            
            if (response.success) {
              // 更新图书状态
              book.status = 'borrowed';
              book.stock = Math.max(0, book.stock - 1);
              
              H5Toast.success(`成功借阅《${book.title}》`);
              H5Utils.hapticFeedback('success');
              
              // 通知父页面更新借阅数量
              if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                  type: 'borrowCountChanged'
                }, '*');
              }
              
            } else {
              throw new Error(response.message || '借阅失败');
            }
            
          } catch (error) {
            console.error('[图书页面] 借阅失败:', error);
            H5Toast.error(error.message || '借阅失败，请稍后重试');
            H5Utils.hapticFeedback('error');
          } finally {
            this.borrowing[book.id] = false;
          }
        },
        
        // 显示图书详情
        showBookDetail(book) {
          H5Utils.hapticFeedback('light');
          
          // 这里可以实现图书详情弹窗或跳转
          H5Toast.info(`《${book.title}》详情功能开发中...`);
        },
        
        // 刷新数据（覆盖 pullToRefresh mixin 的方法）
        async onRefresh() {
          console.log('[图书页面] 下拉刷新');
          
          this.reset();
          this.currentPage = 1;
          
          try {
            await Promise.all([
              this.loadCategories(),
              this.loadBooks()
            ]);
            
            H5Toast.success('刷新成功');
            
          } catch (error) {
            console.error('[图书页面] 刷新失败:', error);
            H5Toast.error('刷新失败，请稍后重试');
          }
        },
        
        // 刷新图书
        async refreshBooks() {
          H5Utils.hapticFeedback('light');
          await this.onRefresh();
        },
        
        // 设置无限滚动
        setupInfiniteScroll() {
          this.destroyInfiniteScroll = H5Scroll.createInfiniteScroll(() => {
            if (this.canLoadMore) {
              this.loadMore();
            }
          }, 100);
        },
        
        // 状态辅助方法
        getStatusClass(status) {
          const classMap = {
            'available': 'available',
            'borrowed': 'borrowed',
            'unavailable': 'unavailable'
          };
          return classMap[status] || 'unavailable';
        },
        
        getStatusIcon(status) {
          const iconMap = {
            'available': 'bi-check-circle-fill',
            'borrowed': 'bi-clock-fill',
            'unavailable': 'bi-x-circle-fill'
          };
          return iconMap[status] || 'bi-x-circle-fill';
        },
        
        getStatusText(status) {
          const textMap = {
            'available': '可借',
            'borrowed': '已借',
            'unavailable': '不可借'
          };
          return textMap[status] || '未知';
        },
        
        // 用户偏好设置
        saveUserPreferences() {
          const preferences = {
            viewMode: this.viewMode,
            activeFilter: this.activeFilter
          };
          H5Utils.storage.set('bookPagePreferences', preferences, H5Config.cacheExpiry);
        },
        
        restoreUserPreferences() {
          const preferences = H5Utils.storage.get('bookPagePreferences');
          if (preferences) {
            this.viewMode = preferences.viewMode || 'grid';
            this.activeFilter = preferences.activeFilter || 'all';
          }
        },
        
        // 页面清理
        destroy() {
          if (this.destroyInfiniteScroll) {
            this.destroyInfiniteScroll();
          }
          
          if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
          }
        }
      }
    }
    
    // 页面卸载时清理资源
    window.addEventListener('beforeunload', () => {
      const bookPageInstance = window.Alpine?.findClosest(document.body, x => x.destroy);
      if (bookPageInstance) {
        bookPageInstance.destroy();
      }
    });
  </script>
</body>
</html>
