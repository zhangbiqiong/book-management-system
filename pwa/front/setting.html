<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人设置</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet/less" type="text/css" href="css/main.less">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="function-page" x-data="settingApp()">
        <div class="page-header">
            <h2><i class="bi bi-gear"></i> 个人设置</h2>
            <p>管理您的个人信息</p>
        </div>
        
        <form @submit.prevent="saveSettings">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-person"></i> 基本信息</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="username" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="username" x-model="form.username" readonly>

                    </div>
                    
                    <div class="form-group">
                        <label for="email" class="form-label">邮箱地址</label>
                        <input type="email" class="form-control" id="email" x-model="form.email" placeholder="请输入您的邮箱地址" readonly>

                    </div>
                    
                    <div class="form-group">
                        <label for="role" class="form-label">用户角色</label>
                        <input type="text" class="form-control" id="role" x-model="form.role" readonly>

                    </div>
                    
                    <div class="form-group">
                        <label for="status" class="form-label">账户状态</label>
                        <input type="text" class="form-control" id="status" x-model="form.status" readonly>
   
                    </div>
                </div>
            </div>
            

        </form>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="bi bi-shield"></i> 账户操作</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-warning" @click="showChangePasswordModal">
                        <i class="bi bi-key"></i> 修改密码
                    </button>
                    
                    <button type="button" class="btn btn-outline-danger" @click="logout">
                        <i class="bi bi-box-arrow-right"></i> 退出登录
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改密码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" x-data="passwordForm()">
                    <form @submit.prevent="handleChangePassword">
                        <div class="mb-3">
                            <label for="oldPassword" class="form-label">当前密码</label>
                            <input type="password" class="form-control" id="oldPassword" x-model="form.oldPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">新密码</label>
                            <input type="password" class="form-control" id="newPassword" x-model="form.newPassword" required>
                            <div class="form-text">密码长度至少6位</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">确认新密码</label>
                            <input type="password" class="form-control" id="confirmPassword" x-model="form.confirmPassword" required>
                        </div>
                        
                        <div x-show="error" class="alert alert-danger" role="alert">
                            <span x-text="error"></span>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                <span x-show="!loading">确认修改</span>
                                <span x-show="loading">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    修改中...
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/less@4.1.3/dist/less.min.js"></script>
    <!-- 通用工具 -->
    <script src="js/app.js"></script>
    
    <script>
        function settingApp() {
            return {
                form: {
                    username: '',
                    email: '',
                    role: '',
                    status: ''
                },
                loading: false,
                
                init() {
                    // 检查登录状态
                    if (!UserManager.isLoggedIn()) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    this.loadUserInfo();
                },
                
                async loadUserInfo() {
                    this.loading = true;
                    
                    try {
                        const response = await ApiService.getCurrentUser();
                        
                        if (response.success) {
                            this.form = {
                                username: response.user.username || '',
                                email: response.user.email || '',
                                role: this.getRoleText(response.user.role) || '',
                                status: this.getStatusText(response.user.status) || ''
                            };
                        } else {
                            throw new Error(response.message || '获取用户信息失败');
                        }
                        
                    } catch (error) {
                        console.error('获取用户信息失败:', error);
                        AppUtils.showMessage(error.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async refreshUserInfo() {
                    await this.loadUserInfo();
                    AppUtils.showMessage('用户信息已刷新', 'success');
                },
                
                showChangePasswordModal() {
                    const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
                    modal.show();
                },
                
                async logout() {
                    if (confirm('确定要退出登录吗？')) {
                        try {
                            // 清除当前页面的状态
                            this.form = {
                                username: '',
                                email: '',
                                role: '',
                                status: ''
                            };
                            
                            // 调用退出登录，由后端处理重定向
                            UserManager.logout();
                        } catch (error) {
                            console.error('登出失败:', error);
                            // 即使出错，也要跳转到登录页面
                            window.location.href = 'login.html';
                        }
                    }
                },
                
                getRoleText(role) {
                    const roleMap = {
                        'admin': '管理员',
                        'user': '普通用户'
                    };
                    return roleMap[role] || role;
                },
                
                getStatusText(status) {
                    const statusMap = {
                        'enabled': '正常',
                        'disabled': '已禁用'
                    };
                    return statusMap[status] || status;
                }
            }
        }
        
        function passwordForm() {
            return {
                form: {
                    oldPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                },
                loading: false,
                error: '',
                
                async handleChangePassword() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        // 验证表单
                        if (!this.form.oldPassword || !this.form.newPassword || !this.form.confirmPassword) {
                            throw new Error('请填写所有密码字段');
                        }
                        
                        if (this.form.newPassword.length < 6) {
                            throw new Error('新密码长度至少6位');
                        }
                        
                        if (this.form.newPassword !== this.form.confirmPassword) {
                            throw new Error('两次输入的新密码不一致');
                        }
                        
                        // 获取当前用户名
                        const currentUser = UserManager.getCurrentUser();
                        if (!currentUser || !currentUser.username) {
                            throw new Error('无法获取当前用户信息');
                        }
                        
                        // 调用修改密码API
                        const response = await ApiService.request('/change-password', {
                            method: 'POST',
                            data: {
                                username: currentUser.username,
                                oldPassword: this.form.oldPassword,
                                newPassword: this.form.newPassword
                            }
                        });
                        
                        if (response.success) {
                            AppUtils.showMessage('密码修改成功', 'success');
                            
                            // 关闭模态框
                            const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                            modal.hide();
                            
                            // 清空表单
                            this.form = {
                                oldPassword: '',
                                newPassword: '',
                                confirmPassword: ''
                            };
                        } else {
                            throw new Error(response.message || '密码修改失败');
                        }
                        
                    } catch (error) {
                        console.error('修改密码失败:', error);
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    </script>
</body>
</html> 