<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>借阅记录</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet/less" type="text/css" href="css/main.less">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <!-- Less.js -->
    <script src="https://cdn.jsdelivr.net/npm/less@4.1.3/dist/less.min.js"></script>
</head>
<body>
    <div class="function-page" x-data="borrowApp()">
        <div class="page-header">
            <h2><i class="bi bi-journal-check"></i> 借阅记录</h2>
            <p>查看您的借阅历史和当前借阅状态</p>
        </div>
        
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-6">
                    <select class="form-select" x-model="filterStatus">
                        <option value="">全部状态</option>
                        <option value="借阅中">借阅中</option>
                        <option value="已归还">已归还</option>
                        <option value="逾期">逾期</option>
                    </select>
                </div>
                <div class="col-6">
                    <button class="btn btn-outline-primary w-100" @click="refreshRecords">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
        </div>
        
        <div x-show="!loading && borrowRecords.length > 0">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">共 <span x-text="filteredRecords.length"></span> 条借阅记录</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" :class="{ 'active': sortBy === 'borrowDate' }" @click="sortBy = 'borrowDate'">
                        借阅时间
                    </button>
                    <button class="btn btn-outline-secondary" :class="{ 'active': sortBy === 'returnDate' }" @click="sortBy = 'returnDate'">
                        归还时间
                    </button>
                </div>
            </div>
            
            <div class="borrow-list">
                <template x-for="record in filteredRecords" :key="record.id">
                    <div class="card borrow-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-3">
                                    <div class="book-cover">
                                        <i class="bi bi-book text-primary" style="font-size: 3rem;"></i>
                                    </div>
                                </div>
                                <div class="col-9">
                                    <h5 class="card-title" x-text="record.bookTitle"></h5>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-person"></i> <span x-text="record.author"></span>
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-calendar"></i> 借阅时间：<span x-text="formatDate(record.borrowDate)"></span>
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-calendar-check"></i> 应还时间：<span x-text="formatDate(record.dueDate)"></span>
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge" :class="{
                                            'bg-primary': record.status === '借阅中',
                                            'bg-success': record.status === '已归还',
                                            'bg-danger': record.status === '逾期'
                                        }" x-text="record.status"></span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-info me-1" @click="showRecordDetail(record)">
                                                <i class="bi bi-eye"></i> 详情
                                            </button>
                                            <button x-show="record.status === '借阅中'" class="btn btn-sm btn-outline-warning" @click="renewBook(record)">
                                                <i class="bi bi-arrow-clockwise"></i> 续借
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <div x-show="loading" class="loading">
            <div class="spinner-border" role="status"></div>
        </div>
        
        <div x-show="!loading && borrowRecords.length === 0" class="empty-state">
            <div class="empty-icon"><i class="bi bi-journal-check"></i></div>
            <h3>暂无借阅记录</h3>
            <p>您还没有借阅过任何图书</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/less@4.1.3/dist/less.min.js"></script>
    
    <script>
        function borrowApp() {
            return {
                filterStatus: '',
                sortBy: 'borrowDate',
                borrowRecords: [],
                loading: false,
                
                init() {
                    this.loadBorrowRecords();
                },
                
                async loadBorrowRecords() {
                    this.loading = true;
                    
                    try {
                        await this.simulateLoadRecords();
                    } catch (error) {
                        console.error('加载借阅记录失败:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                simulateLoadRecords() {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            const mockRecords = [
                                {
                                    id: 1,
                                    bookTitle: 'JavaScript高级程序设计',
                                    author: 'Nicholas C. Zakas',
                                    borrowDate: '2024-01-15',
                                    dueDate: '2024-02-15',
                                    returnDate: null,
                                    status: '借阅中',
                                    isbn: '9787115545381'
                                },
                                {
                                    id: 2,
                                    bookTitle: '百年孤独',
                                    author: '加西亚·马尔克斯',
                                    borrowDate: '2024-01-10',
                                    dueDate: '2024-02-10',
                                    returnDate: '2024-02-05',
                                    status: '已归还',
                                    isbn: '9787544253994'
                                },
                                {
                                    id: 3,
                                    bookTitle: '人类简史',
                                    author: '尤瓦尔·赫拉利',
                                    borrowDate: '2024-01-05',
                                    dueDate: '2024-02-05',
                                    returnDate: null,
                                    status: '逾期',
                                    isbn: '9787508640757'
                                }
                            ];
                            
                            this.borrowRecords = mockRecords;
                            resolve();
                        }, 1000);
                    });
                },
                
                refreshRecords() {
                    this.loadBorrowRecords();
                },
                
                showRecordDetail(record) {
                    const detail = `借阅详情：
书名：${record.bookTitle}
作者：${record.author}
ISBN：${record.isbn}
借阅时间：${this.formatDate(record.borrowDate)}
应还时间：${this.formatDate(record.dueDate)}
状态：${record.status}`;
                    
                    if (record.returnDate) {
                        detail += `\n归还时间：${this.formatDate(record.returnDate)}`;
                    }
                    
                    alert(detail);
                },
                
                renewBook(record) {
                    if (confirm(`确定要续借《${record.bookTitle}》吗？`)) {
                        // 模拟续借操作
                        const newDueDate = new Date(record.dueDate);
                        newDueDate.setDate(newDueDate.getDate() + 30);
                        record.dueDate = newDueDate.toISOString().split('T')[0];
                        
                        alert('续借成功！新的归还时间为：' + this.formatDate(record.dueDate));
                    }
                },
                
                formatDate(dateString) {
                    if (!dateString) return '未设置';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-CN');
                },
                
                get filteredRecords() {
                    let filtered = this.borrowRecords;
                    
                    if (this.filterStatus) {
                        filtered = filtered.filter(record => record.status === this.filterStatus);
                    }
                    
                    // 排序
                    filtered = _.orderBy(filtered, [this.sortBy], ['desc']);
                    
                    return filtered;
                }
            }
        }
    </script>
</body>
</html> 