<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书查询</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet/less" type="text/css" href="css/main.less">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <!-- Less.js -->
    <script src="https://cdn.jsdelivr.net/npm/less@4.1.3/dist/less.min.js"></script>
</head>
<body>
    <div class="function-page" x-data="bookApp()">
        <div class="page-header">
            <h2><i class="bi bi-search"></i> 图书查询</h2>
            <p>搜索您需要的图书信息</p>
        </div>
        
        <div class="search-box">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="输入书名、作者或ISBN进行搜索..." x-model="searchQuery" @keyup.enter="searchBooks" :disabled="loading">
                <button class="btn btn-primary" @click="searchBooks" :disabled="loading">
                    <span x-show="!loading"><i class="bi bi-search"></i> 搜索</span>
                    <span x-show="loading"><div class="spinner-border spinner-border-sm"></div></span>
                </button>
            </div>
        </div>
        
        <!-- <div class="mb-3">
            <div class="row g-2">
                <div class="col-6">
                    <select class="form-select" x-model="filterCategory">
                        <option value="">全部分类</option>
                        <option value="古典文学">古典文学</option>
                        <option value="现代文学">现代文学</option>
                        <option value="科技">科技</option>
                        <option value="历史">历史</option>
                        <option value="艺术">艺术</option>
                        <option value="教育">教育</option>
                    </select>
                </div>
                <div class="col-6">
                    <select class="form-select" x-model="filterStatus">
                        <option value="">全部状态</option>
                        <option value="可借">可借</option>
                        <option value="已借出">已借出</option>
                    </select>
                </div>
            </div>
        </div> -->
        
        <!-- <div x-show="!loading && books.length > 0">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">找到 <span x-text="filteredBooks.length"></span> 本图书</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" :class="{ 'active': sortBy === 'title' }" @click="sortBy = 'title'">
                        书名
                    </button>
                    <button class="btn btn-outline-secondary" :class="{ 'active': sortBy === 'author' }" @click="sortBy = 'author'">
                        作者
                    </button>
                    <button class="btn btn-outline-secondary" :class="{ 'active': sortBy === 'publishDate' }" @click="sortBy = 'publishDate'">
                        出版日期
                    </button>
                </div>
            </div> -->
            
            <div class="book-list">
                <template x-for="book in filteredBooks" :key="book.id">
                    <div class="card book-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-3">
                                    <div class="book-cover">
                                        <i class="bi bi-book text-primary" style="font-size: 3rem;"></i>
                                    </div>
                                </div>
                                <div class="col-9">
                                    <h5 class="card-title" x-text="book.title"></h5>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-person"></i> <span x-text="book.author"></span>
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-tag"></i> <span x-text="book.category || '未分类'"></span>
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-upc"></i> <span x-text="book.isbn"></span>
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-building"></i> <span x-text="book.publisher"></span>
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge" :class="{
                                            'bg-success': book.stock > 0,
                                            'bg-warning': book.stock === 0
                                        }" x-text="book.stock > 0 ? '可借' : '已借出'"></span>
                                        <div>
                                            <span class="text-muted me-2">库存: <span x-text="book.stock"></span></span>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- 分页 -->
            <div x-show="pagination && pagination.totalPages > 1" class="d-flex justify-content-center mt-3">
                <nav>
                    <ul class="pagination">
                        <li class="page-item" :class="{ 'disabled': pagination && pagination.page <= 1 }">
                            <button class="page-link" @click="changePage(pagination ? pagination.page - 1 : 1)" :disabled="pagination && pagination.page <= 1">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                        </li>
                        <template x-for="page in getPageNumbers()" :key="page">
                            <li class="page-item" :class="{ 'active': pagination && page === pagination.page }">
                                <button class="page-link" @click="changePage(page)" x-text="page"></button>
                            </li>
                        </template>
                        <li class="page-item" :class="{ 'disabled': pagination && pagination.page >= pagination.totalPages }">
                            <button class="page-link" @click="changePage(pagination ? pagination.page + 1 : 1)" :disabled="pagination && pagination.page >= pagination.totalPages">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        
        <!-- <div x-show="loading" class="loading">
            <div class="spinner-border" role="status"></div>
        </div>
        
        <div x-show="!loading && books.length === 0 && hasSearched" class="empty-state">
            <div class="empty-icon"><i class="bi bi-search"></i></div>
            <h3>未找到相关图书</h3>
            <p>请尝试使用其他关键词搜索</p>
        </div>
        
        <div x-show="!loading && books.length === 0 && !hasSearched" class="empty-state">
            <div class="empty-icon"><i class="bi bi-book"></i></div>
            <h3>开始搜索图书</h3>
            <p>在搜索框中输入关键词开始查找</p>
        </div>
    </div> -->

    <!-- 图书详情模态框 -->
    <div class="modal fade" id="bookDetailModal" tabindex="-1" x-data="{ selectedBook: null }" @showBookDetail.window="selectedBook = $event.detail">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">图书详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div x-show="selectedBook">
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <i class="bi bi-book text-primary" style="font-size: 5rem;"></i>
                            </div>
                            <div class="col-md-8">
                                <h4 x-text="selectedBook ? selectedBook.title : ''"></h4>
                                <p><strong>作者：</strong><span x-text="selectedBook ? selectedBook.author : ''"></span></p>
                                <p><strong>出版社：</strong><span x-text="selectedBook ? selectedBook.publisher : ''"></span></p>
                                <p><strong>ISBN：</strong><span x-text="selectedBook ? selectedBook.isbn : ''"></span></p>
                                <p><strong>分类：</strong><span x-text="selectedBook ? (selectedBook.category || '未分类') : ''"></span></p>
                                <p><strong>出版日期：</strong><span x-text="selectedBook ? AppUtils.formatDate(selectedBook.publishDate) : ''"></span></p>
                                <p><strong>价格：</strong><span x-text="selectedBook ? ('¥' + selectedBook.price) : ''"></span></p>
                                <p><strong>库存：</strong><span x-text="selectedBook ? selectedBook.stock : ''"></span></p>
                                <p x-show="selectedBook && selectedBook.description"><strong>简介：</strong><span x-text="selectedBook ? selectedBook.description : ''"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/less@4.1.3/dist/less.min.js"></script>
    <!-- 通用工具 -->
    <script src="js/app.js"></script>
    
    <script>
        function bookApp() {
            return {
                searchQuery: '',
                filterCategory: '',
                filterStatus: '',
                sortBy: 'title',
                sortOrder: 'asc',
                books: [],
                pagination: null,
                loading: false,
                hasSearched: false,
                currentPage: 1,
                pageSize: 10,
                
                init() {
                    // 检查登录状态
                    if (!UserManager.isLoggedIn()) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // 初始化分页对象
                    this.pagination = { page: 1, totalPages: 1, totalItems: 0 };
                    
                    // 加载初始数据
                    this.loadBooks();
                },
                
                async searchBooks() {
                    this.currentPage = 1;
                    this.pagination = { page: 1, totalPages: 1, totalItems: 0 };
                    await this.loadBooks();
                },
                
                async loadBooks() {
                    this.loading = true;
                    this.hasSearched = true;
                    
                    try {
                        const params = {
                            page: this.currentPage || 1,
                            pageSize: this.pageSize || 10,
                            sortBy: this.sortBy || 'title',
                            sortOrder: this.sortOrder || 'asc'
                        };
                        
                        if (this.searchQuery && this.searchQuery.trim()) {
                            params.search = this.searchQuery.trim();
                        }
                        
                        const response = await ApiService.getBooks(params);
                        
                        if (response && response.success) {
                            this.books = response.data || [];
                            this.pagination = response.pagination || { page: 1, totalPages: 1, totalItems: 0 };
                        } else {
                            throw new Error((response && response.message) || '获取图书列表失败');
                        }
                        
                    } catch (error) {
                        console.error('获取图书列表失败:', error);
                        const errorMessage = error && error.message ? error.message : '获取图书列表失败';
                        AppUtils.showMessage(errorMessage, 'error');
                        this.books = [];
                        this.pagination = { page: 1, totalPages: 1, totalItems: 0 };
                    } finally {
                        this.loading = false;
                    }
                },
                
                async changePage(page) {
                    if (this.pagination && page >= 1 && page <= this.pagination.totalPages) {
                        this.currentPage = page;
                        await this.loadBooks();
                    }
                },
                
                getPageNumbers() {
                    if (!this.pagination || !this.pagination.totalPages) return [];
                    
                    const totalPages = this.pagination.totalPages;
                    const currentPage = this.pagination.page || 1;
                    const pages = [];
                    
                    // 显示最多5页
                    let start = Math.max(1, currentPage - 2);
                    let end = Math.min(totalPages, currentPage + 2);
                    
                    if (end - start < 4) {
                        if (start === 1) {
                            end = Math.min(totalPages, start + 4);
                        } else {
                            start = Math.max(1, end - 4);
                        }
                    }
                    
                    for (let i = start; i <= end; i++) {
                        pages.push(i);
                    }
                    
                    return pages;
                },
                
                showBookDetail(book) {
                    if (!book) return;
                    
                    // 使用Alpine.js的事件系统传递数据
                    document.dispatchEvent(new CustomEvent('showBookDetail', { detail: book }));
                    
                    // 使用Bootstrap模态框显示详情
                    const modal = new bootstrap.Modal(document.getElementById('bookDetailModal'));
                    modal.show();
                },
                
                get filteredBooks() {
                    let filtered = this.books || [];
                    
                    if (this.filterCategory) {
                        filtered = filtered.filter(book => book && book.category === this.filterCategory);
                    }
                    
                    if (this.filterStatus) {
                        if (this.filterStatus === '可借') {
                            filtered = filtered.filter(book => book && book.stock > 0);
                        } else if (this.filterStatus === '已借出') {
                            filtered = filtered.filter(book => book && book.stock === 0);
                        }
                    }
                    
                    return filtered;
                }
            }
        }
    </script>
</body>
</html> 