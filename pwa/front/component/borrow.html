<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>借阅记录</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet/less" type="text/css" href="css/main.less">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <!-- Less.js -->
    <script src="https://cdn.jsdelivr.net/npm/less@4.1.3/dist/less.min.js"></script>
</head>
<body>
    <div class="function-page" x-data="borrowApp()">
        <div class="page-header">
            <h2><i class="bi bi-journal-check"></i> 借阅记录</h2>
            <p>查看您的借阅历史和当前借阅状态</p>
        </div>
        
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-6">
                    <select class="form-select" x-model="filterStatus">
                        <option value="">全部状态</option>
                        <option value="borrowed">借阅中</option>
                        <option value="returned">已归还</option>
                        <option value="overdue">逾期</option>
                    </select>
                </div>
                <div class="col-6">
                    <button class="btn btn-outline-primary w-100" @click="refreshRecords">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
        </div>
        
        <div x-show="!loading && (borrowRecords || []).length > 0">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">共 <span x-text="(filteredRecords || []).length"></span> 条借阅记录</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" :class="{ 'active': sortBy === 'borrowDate' }" @click="sortBy = 'borrowDate'">
                        借阅时间
                    </button>
                    <button class="btn btn-outline-secondary" :class="{ 'active': sortBy === 'dueDate' }" @click="sortBy = 'dueDate'">
                        到期时间
                    </button>
                    <button class="btn btn-outline-secondary" :class="{ 'active': sortBy === 'returnDate' }" @click="sortBy = 'returnDate'">
                        归还时间
                    </button>
                </div>
            </div>
            
            <div class="borrow-list">
                <template x-for="record in filteredRecords" :key="record.id">
                    <div class="card borrow-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-3">
                                    <div class="book-cover">
                                        <i class="bi bi-book text-primary" style="font-size: 3rem;"></i>
                                    </div>
                                </div>
                                <div class="col-9">
                                    <h5 class="card-title" x-text="record?.bookTitle || ''"></h5>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-person"></i> 借阅者：<span x-text="record?.borrowerName || ''"></span>
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-calendar"></i> 借阅时间：<span x-text="formatDate(record?.borrowDate)"></span>
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-calendar-check"></i> 应还时间：<span x-text="formatDate(record?.dueDate)"></span>
                                    </p>
                                    <p x-show="record?.returnDate" class="card-text text-muted mb-1">
                                        <i class="bi bi-calendar-x"></i> 归还时间：<span x-text="formatDate(record?.returnDate)"></span>
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge" :class="{
                                            'bg-primary': record?.status === 'borrowed',
                                            'bg-success': record?.status === 'returned',
                                            'bg-danger': record?.status === 'overdue'
                                        }" x-text="getStatusText(record?.status)"></span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-info me-1" @click="showRecordDetail(record)">
                                                <i class="bi bi-eye"></i> 详情
                                            </button>
                                            <button x-show="record?.status === 'borrowed'" class="btn btn-sm btn-outline-warning" @click="renewBook(record)">
                                                <i class="bi bi-arrow-clockwise"></i> 续借
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- 分页 -->
            <div x-show="pagination && pagination.totalPages > 1" class="d-flex justify-content-center mt-3">
                <nav>
                    <ul class="pagination">
                        <li class="page-item" :class="{ 'disabled': (pagination?.page || 1) <= 1 }">
                            <button class="page-link" @click="changePage((pagination?.page || 1) - 1)" :disabled="(pagination?.page || 1) <= 1">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                        </li>
                        <template x-for="page in getPageNumbers()" :key="page">
                            <li class="page-item" :class="{ 'active': page === (pagination?.page || 1) }">
                                <button class="page-link" @click="changePage(page)" x-text="page"></button>
                            </li>
                        </template>
                        <li class="page-item" :class="{ 'disabled': (pagination?.page || 1) >= (pagination?.totalPages || 1) }">
                            <button class="page-link" @click="changePage((pagination?.page || 1) + 1)" :disabled="(pagination?.page || 1) >= (pagination?.totalPages || 1)">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        
        <div x-show="loading" class="loading">
            <div class="spinner-border" role="status"></div>
        </div>
        
        <div x-show="!loading && (borrowRecords || []).length === 0" class="empty-state">
            <div class="empty-icon"><i class="bi bi-journal-check"></i></div>
            <h3>暂无借阅记录</h3>
            <p>您还没有借阅过任何图书</p>
        </div>
    </div>

    <!-- 借阅详情模态框 -->
    <div class="modal fade" id="borrowDetailModal" tabindex="-1" x-data="detailModal()">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">借阅详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div x-show="selectedRecord">
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <i class="bi bi-book text-primary" style="font-size: 5rem;"></i>
                            </div>
                            <div class="col-md-8">
                                <h4 x-text="selectedRecord?.bookTitle || ''"></h4>
                                <p><strong>借阅者：</strong><span x-text="selectedRecord?.borrowerName || ''"></span></p>
                                <p><strong>借阅时间：</strong><span x-text="formatDate(selectedRecord?.borrowDate)"></span></p>
                                <p><strong>应还时间：</strong><span x-text="formatDate(selectedRecord?.dueDate)"></span></p>
                                <p x-show="selectedRecord?.returnDate"><strong>归还时间：</strong><span x-text="formatDate(selectedRecord?.returnDate)"></span></p>
                                <p><strong>状态：</strong><span x-text="getStatusText(selectedRecord?.status)"></span></p>
                                <p x-show="selectedRecord?.overdueDays > 0"><strong>逾期天数：</strong><span x-text="(selectedRecord?.overdueDays || 0) + '天'"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/less@4.1.3/dist/less.min.js"></script>
    <!-- 通用工具 -->
    <script src="js/app.js"></script>
    
    <script>
        function detailModal() {
            return {
                selectedRecord: null,
                
                init() {
                    // 监听显示详情事件
                    document.addEventListener('showRecordDetail', (event) => {
                        this.selectedRecord = event.detail;
                    });
                },
                
                formatDate(dateString) {
                    if (!dateString) return '未设置';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-CN');
                },
                
                getStatusText(status) {
                    if (!status) return '未知';
                    const statusMap = {
                        'borrowed': '借阅中',
                        'returned': '已归还',
                        'overdue': '逾期'
                    };
                    return statusMap[status] || status;
                }
            }
        }
        
        function borrowApp() {
            return {
                filterStatus: '',
                sortBy: 'borrowDate',
                borrowRecords: [],
                pagination: {
                    page: 1,
                    totalPages: 1,
                    totalItems: 0
                },
                loading: false,
                currentPage: 1,
                pageSize: 10,
                
                init() {
                    // 检查登录状态
                    if (!UserManager.isLoggedIn()) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    this.loadBorrowRecords();
                },
                
                async loadBorrowRecords() {
                    this.loading = true;
                    
                    try {
                        const params = {
                            page: this.currentPage,
                            pageSize: this.pageSize
                        };
                        
                        if (this.filterStatus) {
                            params.status = this.filterStatus;
                        }
                        
                        const response = await ApiService.getBorrows(params);
                        
                        if (response.success) {
                            this.borrowRecords = response.data || [];
                            this.pagination = response.pagination || {
                                page: 1,
                                totalPages: 1,
                                totalItems: 0
                            };
                        } else {
                            throw new Error(response.message || '获取借阅记录失败');
                        }
                        
                    } catch (error) {
                        console.error('获取借阅记录失败:', error);
                        AppUtils.showMessage(error.message, 'error');
                        this.borrowRecords = [];
                        this.pagination = {
                            page: 1,
                            totalPages: 1,
                            totalItems: 0
                        };
                    } finally {
                        this.loading = false;
                    }
                },
                
                async refreshRecords() {
                    this.currentPage = 1;
                    await this.loadBorrowRecords();
                },
                
                async changePage(page) {
                    if (page >= 1 && page <= (this.pagination?.totalPages || 1)) {
                        this.currentPage = page;
                        await this.loadBorrowRecords();
                    }
                },
                
                getPageNumbers() {
                    const totalPages = this.pagination?.totalPages || 1;
                    const currentPage = this.pagination?.page || 1;
                    const pages = [];
                    
                    // 显示最多5页
                    let start = Math.max(1, currentPage - 2);
                    let end = Math.min(totalPages, currentPage + 2);
                    
                    if (end - start < 4) {
                        if (start === 1) {
                            end = Math.min(totalPages, start + 4);
                        } else {
                            start = Math.max(1, end - 4);
                        }
                    }
                    
                    for (let i = start; i <= end; i++) {
                        pages.push(i);
                    }
                    
                    return pages;
                },
                
                showRecordDetail(record) {
                    // 检查记录是否存在
                    if (!record) {
                        AppUtils.showMessage('记录不存在', 'error');
                        return;
                    }
                    
                    // 使用Alpine.js的事件系统传递数据
                    document.dispatchEvent(new CustomEvent('showRecordDetail', { detail: record }));
                    
                    // 使用Bootstrap模态框显示详情
                    const modal = new bootstrap.Modal(document.getElementById('borrowDetailModal'));
                    modal.show();
                },
                
                async renewBook(record) {
                    if (confirm(`确定要续借《${record?.bookTitle || '未知图书'}》吗？`)) {
                        try {
                            // 计算新的到期日期（延长30天）
                            const newDueDate = new Date(record?.dueDate || new Date());
                            newDueDate.setDate(newDueDate.getDate() + 30);
                            
                            const response = await ApiService.updateBorrow(record?.id, {
                                dueDate: newDueDate.toISOString().split('T')[0]
                            });
                            
                            if (response.success) {
                                AppUtils.showMessage('续借成功！', 'success');
                                await this.loadBorrowRecords(); // 刷新列表
                            } else {
                                throw new Error(response.message || '续借失败');
                            }
                        } catch (error) {
                            console.error('续借失败:', error);
                            AppUtils.showMessage(error.message, 'error');
                        }
                    }
                },
                
                formatDate(dateString) {
                    if (!dateString) return '未设置';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-CN');
                },
                
                getStatusText(status) {
                    if (!status) return '未知';
                    const statusMap = {
                        'borrowed': '借阅中',
                        'returned': '已归还',
                        'overdue': '逾期'
                    };
                    return statusMap[status] || status;
                },
                
                get filteredRecords() {
                    let filtered = this.borrowRecords || [];
                    
                    if (this.filterStatus) {
                        filtered = filtered.filter(record => record?.status === this.filterStatus);
                    }
                    
                    // 排序
                    filtered = _.orderBy(filtered, [this.sortBy], ['desc']);
                    
                    return filtered;
                }
            }
        }
    </script>
</body>
</html> 